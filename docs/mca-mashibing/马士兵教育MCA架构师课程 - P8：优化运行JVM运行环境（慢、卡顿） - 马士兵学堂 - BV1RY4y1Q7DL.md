# 系列 6：P8：优化运行JVM运行环境（慢、卡顿） - 马士兵学堂 - BV1RY4y1Q7DL

刚才就是那个卖了回放一波文体了啊。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_1.png)

刚刚是讲到哪的时候，是不是讲到阿里的时候，其实就是很简单，这个安利呢在它的内部的编程规约里头，有一个要求创建线程池，线程或者线程池的时候，必须指定有意义的线程名称，大联合政策对。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_3.png)

为什么呀，他说你们想想看吧，假如我在内存之中定定定位出来。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_5.png)

说这个线程它产生了一些问题，没问题的，哎，这就是总而言之，c900 分百看到了吗，他们说阿after death，bk这个cpu百分百这样的一个问题，那这个现场是干嘛使的，我们得知道。

所以在安利的规定公约里，现成的名称要有一呃呃，扩展一点项目内容，作为现场来说呢，一般刚才那个问题说cpu百分百，cpu爆了之后，你怎么去定位呢，怎么定位呢，首先给他揪出来是哪个线程。

然后这里面分两种情况，你认比较，如果你揪出来一个线程在那里，他特别忙，占很多视线，那么这里面分两种情况，我就把它停掉了。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_7.png)

![](img/3e5ee26e6ad961a0d48af46acb4935d9_8.png)

啊这里面的分两种情况，第一种情况占cpu的，如果是什么线程的，是业务情况，那啥也别说，你好不容易去调你的业务代码，第二个如果站c u的是j v m内部线程，这个一般是gc线程。

那说明一定是发生了这些特殊情况，比如说他频繁的物理所，因为调色之后在哪来来回回抽，比如说他一次f d c的时间超级长，cpu在那里使劲分离c他不有别的事，所以这个时候你就需要去看你的知识日志，去看过吗。

听懂了吗，所以你怎么调，别人在问你这个问题的时候该怎么回答，大家是不是听过，我再重复一遍，这个问题就是面试官的问题，假如你的系统它产生了cpu暴增的情况，你如何定位，定位的话相当简单。

你可以说alphastation store里能观察，观测到这个没有问题，另外定位完问题之后，你得继续说，你说如果是一个业务线程，那我就定位业务业务的问题，业务方面的问题，我现成名字取的要有意义。

我就知道是哪个线程，你关注这个线程代码就可以了，假如说是不是业务线程，而是系统线程，那说明一定是gc的问题，我要去观测gc的认知，看看到底发生了什么，是om，是频繁gc了还是什啊，这个回答大家听清楚啊。

有没有谁有疑问的，唯一就是好处吗，其他有没有人会觉得，有回音是吧，what来再重新试一下，hello，现在可以了吗，哎呦我勒个去啊，继续现在好了是吧，嗯那就行。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_10.png)

o m为什么会造成cpu了吗，om并不会造成。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_12.png)

但是他不断的f d c消耗cpu资源，就会造成cpu暴增。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_14.png)

不会拉满，听懂了吗，所以你要观测具体是哪个线程，那么如果你呃我们继续聊啊，这个，呃假如说我们你观测到的是业务线程，那么业务线程呢，你就观察业务线程的一些特殊情况，这个业务线程特殊情况我怎么去观察呢。

注意看看这里。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_16.png)

我重新把这十项环实验环境搭一下。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_18.png)

把程序起来，把office起来挂上去。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_20.png)

在office里面还有一个命令，这个命令叫什么，叫thread回车thread呢。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_22.png)

它会把整个这个java进程里面的所有线程全给你，列出来，哪个县城站的站。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_24.png)

这cpu是多少，哪个线程占的cpu是多少等等，现在我们假设如果这个业务线程有问题，17号观察这个号码，17号业务线程有问题。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_26.png)

那么这时候你可以怎么做呢，thread 17回车。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_28.png)

他就会把这个业务线程里面，在这个线程里面是哪个方法，调用了哪个方法又调用哪个方法，总而言之就是把线程b站给打印出。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_30.png)

你去调整你的现成的业务逻辑，去观察一下到底是哪个方法有可能会产生问题，去读你对应方法的代码好了，同学们不知道大家听清楚没有，这个问题大家是不是能回答了，至少初级的能回答了，再重复一遍。

由于中间老出一些情况，我再重复一遍，这个问题是什么，就是面试官如果问你cpu暴增的情况下，如何排查。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_32.png)

记得我好像是在哪记录过了，所以重新给大家记录一遍吧，cpu帮他如何排查呀，如果你用普通的那个那个linux命令的话，就是呃怎么查的，就top，杠hp就可以就找出来哪个进程里面，哪个线程占比最高。

然后呢再用jtag去观察这个线程的一些情况，如果你用aths的话，怎么做呢，dashboard或者是thread命令以及thread命令加上什么，加上这个线程号，呃当然分如果查出问题来分两种情况。

第一种是业务线程，那你就查业务，啥也别说，第二种是什么b c线条，那你就不去读gc日志，然后根据日志来了解一些具体情况好了，这个过程不知道我说清楚没有，有没有同学有疑问的，这是cpu暴增如何排查。

当然面试官里头还经常会问一个问题，死锁如何排查，假如你怀疑你系统里会有死锁，死锁是后排的，这个怎么查，那么问题来了。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_34.png)

怎么看dc日志啊，你的问题你留着吧。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_36.png)

今天讲不到那么深，那么深的深度好了，同学们这问题怎么怎么回答，同学们听我说，观察gc就是观察这个线程的死锁情况，如果你用aths超级简单，auth是这么玩的，还是thread命令thread。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_38.png)

the help。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_40.png)

你会发现它有一个命令叫什么，叫杠b杠b的意思是，include blocking threaten，find the thread，who is holding a lock that blocks。

the most lethreats，读一下，他说你把那个什么东西给我揪出来啊，有一个县城，这个县城只有一把锁，他这把所持有的时间特别长，其他的线程都得给我block阻塞，说明这地儿一定是有思索。

听懂了吗，所以你就查怎么查，自然刚毕，当然我这个程序里头是没有思索的。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_42.png)

所以你看不出来，所以这块的话呢我告诉你数学如何排查，如果你用最初级的命令，你还是要jdk来观察线程的情况，这个有点他那个线程的信息给的不是特别明确，而且线程特别多的时候比较难观察。

但是你如果用aths直接就给你定位出来了，artist用什么四川当地搞定啊。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_44.png)

关于刚刚讲的这一小段，有没有同学有疑问呢，这console也可以吗，没用过，不知道可以可不可以，这console不知道可以不可以啊，这个excel也能看到搜索对，可以的，好我们可以继续了吗，可以继续。

我要给老师扣一。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_46.png)

好那下面的问题是我们刚才不是说了吗。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_48.png)

这哥们是在不断的呃产生f d c嘛，对不对，那就是说刚才我们分析过他不断产生f d c，产生了fg c之后的问题出在哪呢，就是由于有一些对象不断的占用内存的，产生内存泄漏，那现在的问题就在于。

我们怎么去揪出那些对象来，好。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_50.png)

怎么揪出那些对象来，是哪些对象占用内存的，听我说，这个时候一般我们使用哪个命令呢。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_52.png)

这个命令呢，authors里面唯一不能够替代java自带的命令行，的一个命令，就是他这个命令叫jay map。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_54.png)

对啊，当然了，你不用背啊。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_56.png)

就是我给你讲的这些东西你都不用背呃，为啥呢，因为像老师这么贴心的人，肯定是都给你记录好了，好吧，就是，这个命令呢是这个啊，请大家记住它，就是他叫j map，ok这个命令是最常用的j map。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_58.png)

j map的意思是什么呢。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_60.png)

来看这里，gm gpistol histogram指的是生成一个内存图。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_62.png)

后面的要跟我们的进程的id看一下。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_64.png)

11778。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_66.png)

1778回车。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_68.png)

呃由于它产生的结果是特别长。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_70.png)

所以这时候呢我加一点小东西。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_72.png)

把前面的给大家截出来，就不用盖帽了，还黑点20就可以了。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_74.png)

把前面几行列出来，要用japan j map命令生成内存的内存图。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_76.png)

把前面20行列出来，回车哦，你会看到它最终产生了什么结果呢，是这么一个结果，我们有这样的一个类，它叫做schedued future task，它有多少个对象呢，instances有多少个对象呢。

有39万个对象，与此同时，我们有这么一类叫big animal，它有39万的对象，注意记住了这个数39万，我们再来运行一遍，那依然是39万，完蛋了，已经内存溢出了啊。

out of memory error，看到了吧，重新运行，再来好程序跑起来，为了让大家理解这个命令，j map的命令到底是什么意思，我们重新跑一下回车，sorry，gps，1949，回车你会看到呢。

我有一个scheduled fish test，他现在有2万个对象，node呢有3万个，然后big dancma有2万个，看到了吧，哎你们继续啊，再再再跑一遍，注意你会看到这个对象变成了3万多个了。

依然是那个schedule free task，3万个，再跑一遍，已经变成4万个了，好如果你持续不断地跑的话，你会发现这哥们儿就是这个对象，以及下面的什么big simal以及下面的cut infer。

以及下面的date等等，它在不断的吃内存，不是vip学员那里能领资料吗，可以没问题啊，好这个从他必须会超级会一定会，所以你跟面试官讲，我在正在运行的系统里头执行了j map，你别搞笑了。

面试官一个大嘴巴子抽上来，出门右转拜拜，那有同学说老师我这map能不能用生产机，肯定是不能这么用的，那怎么用啊，好第一种测试环境下的压测，用gmap没问题，听懂了吗，第二种，如果有高可用两台机器。

高可用，我隔离一台，用其中一其中的一台来给他做测试，这个没问题，如果是说那种高可用也不允许，也没有，然后线上的机器我怎么办呀，t c p copy，把来的流量拷贝一份，用另外一台测试机怼上去。

在这台测试机上做实验，这是第三种，第四种，第四种，配置你的常见的jvm的参数配置怎么配呢。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_78.png)

here，就必须配一个参数，这个参数叫叫它叫什么，叫hit down on out of memory error，我这句话是什么意思，读一下，可dump on audience memory era。

资料会给吗，不给没问题啊，take down on olive oliver error，对，把整个堆内存给dump出来，dump成一个文件，那么这个东西在什么时候弹不出来呢。

out of memory error，只要产生om异常之后，它会自动给你生成一个这叫堆转储文件，对专储文件我们可以对对专注文件是什么意思，它就是相当于把你内存里面，这个堆的信息全部给你导成一个文件里。

我们可以用工具对它进行分析，在这里才会用上你们所熟悉的啊，你们所熟知的，你们听说过的mp，虽然我不建议用它，但是网上有很多人讲他的我不太喜欢用它，原因是啥呢，因为它吃内存，吃的比消耗的比较多。

呃堆堆内存就是你有了这个文件之后，分析这个文件能用到的有工具特别多，这vivm本身就可以，还有一个叫j hat的自在的命令也可以，j v vm也可以，m a t也可以，j consol也可以。

这profiler也可以进行dump文件的分析，好吧，在这儿呢，首先，教大家怎么分析吧，啊我看那个anybody问了一个触及灵魂的问题，说这个参数会影响线上性能吗，来各位同学回答一下。

any andy bug啊，安迪的bob鲍国，安迪鲍勃同学会吗，讲个实战大哥，我讲的还不够实战啊，你还要怎么实战，不会的都死了，怕啥对啊，他都已经死了，on out of memory error。

大哥他都已经死了，你有什么可可可可影响的，他已经死人了，你们随便怎么鞭尸都可以吗，对不对啊，所以这东西没没事儿啊，没关系呃，这是一种，当然我给你配置这种的话。

我得等到它out of member error之后，我才能够看到那个堆存储文件，所以有了这个文件之后，怎么进行分析，我能跑这个历程的时候。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_80.png)

讲讲讲另外一个命令就可以了，这个命令是什么呢，就是依然是gnap，当然这个命令还会可以给你产生一个对，专储文件，我再说一遍啊，我只是为了模拟一下，实际你正在运行的这个线上的生产环境，里头的系统。

你不要用gmap，因为直接就把你的把你的机器给你打卡了，卡顿了，听懂了吧，影响它影响非常大，它会产生s t w啊，这个肯定是在生产环境里是不合适的，我给大家讲这个呢，主要是为了你会看到它会生成。

如果你配了刚才那个参数的话，它会生成这么一个文件啊，说了这么一个文件之后，该怎么进行分析，是我们下一步的重点来能get到的，同学老师扣一。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_82.png)

嗯那这个命令怎么用呢，其实你你记着就行了，就很简单，然后file等于什么，p i d等于什么，就就这么简单好j map什么什么什么好。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_84.png)

也不演示了，除了gmap之外。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_86.png)

还有一个命令是什么，除了jyp之外，咱们今天重点讲的不是不是ars吗。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_88.png)

除了gmp之外也可以。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_90.png)

看这里。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_92.png)

回收。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_94.png)

发射里面也有命令，阿特里面有什么命令呢，有这个命令叫做hip dump。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_96.png)

看到了吗，hp down。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_98.png)

okay，那这keep up怎么用啊，help，他会给你几个exams给的非常的到位，hdmp刚刚live hedgtime，什么什么什么，所以你如果想导出一个堆的话，可以dp，如果想导出活的对象。

那就是live time下面的我就编time了，自己根目录下面root下面的嗯嗯今天是，06146月14号点proce，注意这个后缀名是什么，其实没关系的啊，这个后缀名是什么，其实没关系的，听懂了吗。

是无所谓的事情，ok我们就有了这么一个h profile文件，那我们有了这个profile文件，还记得我们的问题吗，我的问题是这样的，就是一个线上的系统，我配了一个参数。

这个参数叫做hip dump on out of memory error，像现在假设它已经产生out of om了，那么这时候它会自动的产生这么一个对，准储文件，而作为我的我我来说。

我一定要分析一下为什么它会产生o o m，我要定位问题，所以我要分析这个文件，这是我们下一步要进行的操作，来可以继续的给老师扣一，那当我们有了这个文件之后，我们怎么去分析啊，参数怎么加。

你你你你想气死我吗，你知道命令参数怎么加，不会是吗，那我那我能说啥，看这里我们不能照顾所有人啊，我们先先照顾大家伙普普遍的平均的水平呃。



![](img/3e5ee26e6ad961a0d48af46acb4935d9_100.png)

当我们有了这个转储文件之后，我们就把它下载了，下载完了之后呢，下载到windows，你打开就行了，好吧，就这么简单，装入我以前有一些呃dump文件啊，我找一下，找到最近的，什么玩意的文件在哪。

我搜一下啊，有一些文件，这，是原来曾经，嗯cross实战加班调教训练营在这里吧，这是我原来曾经那个妆容，这是原来曾经产生过的一个，我们打开来看看就知道是什么意思，就是相对比较简单，c。

work causes，报呃当我们有了这个对专注文件之后，他就会把这个文对文件给你打开，打开之后呢，里边的一些所有的信息，就可以通过这这vo vm给读出来了，比方说这是基本的信息啊。

这就是操作系统是什么，然后java主目录，java版本等等，系统属性显示线程都可以，比方说我我们说刚才的那个实例，sorry，我们说刚才的那个啊那个，这是他的堆，这是它的类好看这里呃。

当我们打开它它这个这个目录的时候，类这个目录，其实你就能看到到底是哪些个类文件，知道吧，哎哪些个对象在占我的实际当中当中的内存了，所以你就直接可以通过它就可以定位出来。

比如说你看到了这个big decimal挣了多少，超级多16万个了，这个也是16万个，16万个，16万个，所以你很容易定位出来，是哪些对象在占用我的空间，接下来你就查你的业务逻辑器就行了。

是不是很简单呃，当然除了这个之外，还会有一些可以帮助你去定位，哪些个对象出了问题的，比如说你要查询哪些对象有问题，可以用什么呢，o q l语言叫object query language，这个我也用的。

其实并不多，给大家稍微演示一下就行了，select，呃s from，比方说java。land。string s执行一下，他会干一件事，他会把整个这个对象里面，整个这个这个内存的转储文件里面。

那些所有的string类型的对象全给你列出来，你可以去观察到底哪个对象有些什么样的问题，o。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_102.png)

这个呢就是怎么分析对称程文件啊，当然像里面的一些小小的细节啊，去怎么去去去去调哪个菜单，会有一些什么特殊的功能呃，我在这儿就不想跟你多说了啊，这个也没什么意思，那么到现在为止。

我觉得面试官再问到你这些问题的时候，我觉得你应该能回答出来了。

![](img/3e5ee26e6ad961a0d48af46acb4935d9_104.png)