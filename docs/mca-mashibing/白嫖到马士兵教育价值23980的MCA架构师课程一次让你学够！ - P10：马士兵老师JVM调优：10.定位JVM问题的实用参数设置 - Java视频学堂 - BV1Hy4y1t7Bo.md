# 系列 2：P10：马士兵老师JVM调优：10.定位JVM问题的实用参数设置 - Java视频学堂 - BV1Hy4y1t7Bo

题不会答的时候就反问他，你这啥意思，我怎么听不懂你问的问题，你能不能再重复一下等等，你是问这方面问题吗，有些那种特别惊艳，特别不丰富的，他就他他他就连不会交流啊，连访问都不敢问，听不懂都不敢问。

别这样就是说一定反问的，问他什么呢，您指的是哪种垃圾回收器好，对于整个这个房间的管理，取决于垃圾回收器是谁，如果是你妈妈，她可能对他进行了分带，如果是你爸爸，ok他也有可能是进行了分区，完全都不一样的。

到目前为止，从jdk的一点，到目前为止gdp 14四一共诞生了十种垃圾回收器，各位小伙伴们，这十种垃圾回收器啥都别说，先把他背过再说，跟面试官先给他砍晕了，刚才有第最后一个问题，不是问吗。

说用一句话证明你的jvm水平特别牛，超级简单，你就告诉他十种垃圾回收机的算法，我都精通，go语言算是第11种，也我也明白rust的语言没有gc，我能告诉你他为什么关于gc这件事，不管你是python。

不管你是quin，不管你是scala，不管你是java，不管你是go，不管你是rust，随便说，你说我这个m水平牛不牛，这些我都知道，对今天我一堂课让你全知道，来看这里，你就等着听就行了。

我还是那句话啊，你就当傻瓜的时候，带着人来轻轻松松听好，大家看这里，作为我们先讲jvm里面这十种，这十种来自回收器呢，你就记住就行了，前面这六种用于分带模型，我一会儿告诉你什么叫分带，就是内存的区域啊。

你们家空间分两大块，一块两块两大块分带模型，这种叫后面这三种用于分区模型，分区模型就是分成一小块一小块一小块一小块的，这叫分区模型，那这种叫做一般用于debug，当然它有背后深刻的设计思想。

我们不去管它，因为这东西叫做没用，absent叫没用，他没做任何事的垃圾回收器是个摆设，一般做debug的时候用到它，就是我这个垃圾到底是怎么分配的，我先不回收它，别着急，我先用abcent。

我不回收它，我跟踪我垃圾的分配过程，这是一种，还有一种就是确认在我整个垃圾回收没有整个内存没有用完之前，我我我我整个程序肯定会退出，我不用垃圾回收器接入这种的，可以用excellent。

因此我们先排除他，这种非常简单，就是他是个摆设，啥都不干，在这里，前面六种，前面六种是哪六种呢，这六种是大多数人做gm调优的时候需要你掌握的，这六种呢适用于分带模型。

分带模型的就是把你的内存分成两个具体的区域，我会讲，你听后面讲分区，今天看时间，如果时间够的话，我可以告诉你们他的算法到底是什么样的，为什么他比分带的算法呢稍微有那么一点点，我们先来讲分带这个概念。

什么叫分带好吧，大家还能跟上吗，能跟上给老师扣个一，我略过了很多细节，但是还是那句话啊，记住先学脉络，好分带模型是把整个的内存区域分成两个大的年代，这两个大年代分别称之为新生代以及老年代。

这平时你们应该也见多了，新生代就是刚刚new出来的对象，老年代就是经过了好多次垃圾回收之后，老是回收不掉，那些老家伙老顽固，什么意思，妈妈进来一次，这个线头没有被收走，长一岁，妈妈又进来一次。

这个线头依然没有被收走，又长一岁，好当长到一定的年龄之后，够年龄了，进入老年代，所以老年老年代里面装的东西可以认为是垃圾回收，不容易回收掉的，而年轻的里面装的东西可以认为是大多数的时候。

一变垃圾就能把它回收掉的，这种的居多，正是由于这样的特点，所以决定了不同的年代里头，他用的不同的算法，好听我说在年轻代里头用的是什么算法呢，这种算法叫拷贝，拷贝算法效率是极高的，非常高。

而在老年代里头用的是mark compact或者是mark sweep，嗯我们先说年轻代，年轻代为什么要用拷贝算法，这里的年轻代呢，拷贝算法它是这么拷贝的，我们我们我们前面讲拷贝的时候。

不是说把这个内存一分为二，只用这一半儿，这边儿呃，用用完了之后需要回收的时候，把这半有用的框机拷到另外一半不，他不是这么干的，因为在整个的工业实践之中，ibm原来做过统计。

一般来讲一次垃圾回收会回收掉我们整个大多数对象的90%，接近90%到95%，你分配了100个对象，一次垃圾回收，你妈妈一次进来就能给你回收掉95个，这是工业的统计，听懂了吧，这是工业的一个统计。

所以针对于这种一次回收95个的话，我就没有必要说给他半撇，给它分成两半，完全平均的，反正你回收的剩下的就5%，我只要能够拷贝的那个空间能乘着5%实际上就可以了，所以这个时候呢在年轻代里面它是这么来分的。

怎么来分呢，它分成三个区域，这三个区域分别叫做伊甸区，伊甸园，人类诞生的地方，对象诞生的地方，另外两个叫survivor，survivor叫幸存者，我们for循环，每个每一次for循环都产生对象怎么办。

产生了十个12345678 90，然后我gc介入一次，干掉了九个，就剩了一个，这一个怎么办呢，直接拷贝到swif去，看懂了吧，然后整个伊甸区全部清除一块完整的内存，全部清除。

对计算机的操作来说就是一个指针移动的事情，超速度超级快，好看这里，在survivor来说，如果下一次dc再介入，下次bc再进入这个survival里，这个如果它依然存活怎么办呢。

你不能把它拷贝到一甸园区，这肯定不合适，那怎么办，拷贝到另外一个survivor，当然这个clever里面同时也会具备着这一次新的dc，从伊甸园区考过来的这些存活的对象，所以大家可以想一下。

就是考来考去，考来考去，当有一些对象老是回收不掉的时候，这时候怎么办呢，进入到老年代这个过程呢，老师做成了动画，为了让你们学得轻松一些，老师真是呕心沥血，我告诉你图，我知道看起来会比文字轻松那个。

但是没有动画轻松好看，这里一个对象从出生到消亡是什么样的呢，当一个对象一旦开始诞生的时候，首先new出这个对象来的时候，优先会在站上分配，但这件的时候你先不用管，一般来说他也不会问到这方面的问题。

先不抠细节，它会首先进入我们的一甸园区，进入到一点去一点，然后经过一次垃圾回收，会进入到我们swever 1，再经过一次垃圾回收进入survival 2，再经过垃圾回收进入survivor，三。

再经过垃圾回收进入survivor 4，再经过垃圾回收，k年龄够了怎么办，老年代这个过程大家看清楚了吗，应该不需要我重新演示一遍，当然我还有同学呢说了很多的细节，说我这个比例到底是多少，是一比二。

那个呢是八比一比一，还有呢参数我具体怎么设，最大的年这个比方说那个年龄值默认是几等等，我就直接告诉你，一般的默认都是15cm s，默认是六，这些东西老师记得比较熟，但是我不想跟你讲这些，因为这些不重要。

你只要知道去哪查就可以搞东，搞定原理之后去查，好吧好了，大家有同学说老师去哪查呀，像老师这么体贴的暖男，当然，我会把这些全都给你总结出来，一篇文档里就让你全插定了，真他娘的体贴，你说这女朋友能少吗。

好开个玩笑啊，来看这里，在这里啊，嗯，当然这里头有一些那个很细节很细节的概念啊，比如说什么叫minor dc，什么叫y dc，什么叫major dc，什么叫food c，这东西呢其实大家记住啊。

概念性的东西呢，不用把它看的特别重要，概念这玩意儿呢是人类发明出来互相之间交流沟通用的，你不要在这上面在那抬杠，你懂吗，尤其是好多年轻的小伙儿愣说我这个东西就叫这个，不能叫别的，这东西就叫粑粑。

不能叫别的是吧，我告诉你概念，这玩意儿就是人类发明出来互相交流沟通用的，你知道是个什么东西都可以，也许在远古，人类把这个当成就叫apple对吧，叫facebook叫trump。

ok那么这个东西呢它就一直一直一直会这么沿用下来，所以不要在这里扣这种概念，真心没有意义，不要勿虚名而处实祸，好大家看这里，当然这里面有一些细节的东西，我先给你略过，不管它还是那句话，先看脉络。

再给大家总结一个动画的图，我希望大家呢这里面有些概念我没有讲到的，讲细的，你先把它略过，当我们有一个对象出来的时候，优先的首先会在站上进行分配，以前有同学可能会说，老师不都是在new在堆上吗。

然而并不是，如果你学过c语言，你就会知道c语言里面有很多对象是可以分配在栈上的，有很多个不能说对象吧，就是有很多个数据结构都可以分配在栈上的，这完全没问题，java语言也是它是可以分配在栈上的。

对象是可以分配在栈上呃，如果能分配在栈上，这个事儿呢就简单了，分配在栈上有什么好处啊，同学们，你们告诉我一个栈弹出之后，大家知道啊，一个线程开始运行，线程里面是方法调方法，每个方法呢对应一个战争。

这个方法一旦运行结束，这个战争啪叽一下弹出去，这里面的对象是不是顺带着立马就消失了，所以不用垃圾回收器介入，你懂吗，根本就不用垃圾回收器介入，不用拉丁回收，这效率得多高，超级高。

所以如果能在栈上分配java的虚拟机，优先会分配在栈上，当然说到这儿，我稍微讲一点细节，站上分配呢有它自己的一些特性，站上分配一般来讲有两个特性，第一个呢你要进行逃逸分析，就是一定不能让他有逃逸。

第二个呢就是一定要能进行标量替换，我们我简单听我说，我一分钟给你讲清楚这两个概念，所谓的逃逸是什么意思，就是你不能有别的方法的引用指向我这对象，不然你随便没了，那我这方法不成指成空指针。

这不就成野指针了吗，著名的野指针问题，dangling pointer，著名的空指针的bug，所以你要做这种分析确认没有逃逸，第二个，什么叫标量替换呢，就是一般战胜我们是分配那种基础数据类型的。

你这个对象可以被那些分解成为基础数据类型的东西来替代，你里边俩int，我就用俩int替代你不就完了吗，搞定我说清楚了吗，有时候你看文章看半天，你也不理解到底啥意思，老师一分钟给你给你给你搞定就完了啊。

小case，还能跟上吗，可以跟上吗，可以跟上给老师扣个一嗯，老师能不能再说一遍，娘的老师说过一分钟，你非得让老师来两分钟是吧，没狗嘿嘿嘿，没关系啊，稍微讲深一点，尤其是基础稍差的没懂很正常。

因为你原来有一些基础你没打，有可能你都不知道什么是战争，什么是战，什么是标量啊等等，这些个呢也很正常，重新再来一小点儿，你看还有人带节奏，说可以快一点对吧，这东西比较牛逼的，而且想受到关注的人。

我就不给你，快开玩笑开玩笑啊，还是那句话，我们照顾基础稍差的好不好，好听我说啊，首先呢一个方法的执行，一个方法，调一个方法，再调一个方法在内存里面呢，它是不同的方法独占的一个空间叫战争。

这么来理解就可以，a方法调了b方法，b方法调了c方法，假如c方法里面new了一个对象，他new在自己的战争上，而不是new在堆空间，那么这个时候呢，什么样的条件是可以放到站上呢，非常简单。

没有别人家的引用指向，就自己用，举个最简单的例子，你一个for循环里面不停的new对象，你说别人理你吗，没人理你，没关系，像这一类的对象可以放在站上，有同学说老师你能用代码证明我来告诉你。

vip课里我专门用代码证明这一点，但由于咱们时间关系，别在这上面费费费劲好吧，因为重点的好多东西我还没给你讲完呢，ok就是没有没没有引用，就是你自己玩嘛，你自己想怎么玩怎么玩，你不用丢在这上面去。

你留在自己的空间里，这个方法没了，直接往外弹，是不是就是垃圾垃圾垃圾都不用管，既然没有引用指向它嘛，对不对，这个就叫逃逸分析，逃逸分析的意思就是有没有一个引用逃出去啊，从我这个方法里面逃出去啊，哈哈哈。

广告一波对，到处都是广告，老是广告都是干货，好看这里嗯，看成员有个什么什么教育，什么教育牛逼过我们的没有，放心吧，20多个年薪上百万的老师教你，来看这里不说了啊，嗯总而言之，在战场分配好了之后。

不用垃圾回收器介入，一谈对象就可以被回收了，这种的最爽效率最高，当然如果说在栈上分配不合适，比如逃逸分析，人家有人要引用指向它，有一个例子里面有个指针指向它了，那怎么办，你不能封到你这里，你自己私有啊。

不能放放你自己兜里，那这时候怎么办，放在堆上嘛，放堆上的时候要看这哥们儿有多大，如果这哥们儿特别大，直接放老年代，刚才我们说老年代空间比年轻再大大，对象直接放老年代好，有同学可能马上就会问老师多大是大。

很简单一个事情，有参数可以确定，我呢今天争取讲理论，然后我们开开开实战，明天我告诉你怎么样设定那些参数，听懂了吧，看看这里面，如果是大对象扔到老年代，老年代里面的垃圾怎么回收啊，负dc嘛。

f d c负dc啊，这叫这这这个应该怎么翻译，也也别翻译了，因为它呢一般都这么叫，叫负dc，年轻代回收啊，全量回收，全体回收，整体回收，年轻代老年代同时回收负d c，如果回收掉好，这个对象就结束了。

那现在问题又来了，假如说他个儿不够大，站上呢也分配不了，那这时候去哪分配呢，一般来讲没有面试问这个呃，一一般没有人问，有人问，你直接给他怼明白之后呢，他基本上就不再会问你，jvm的问题了。

这个下一步的分配呢叫做t r a b t r a b，不管你是t r a b还是分在伊甸区，我刚才说了嘛，刚进出来对象放哪儿，年轻代的一电区里面好，t r a b的概念是什么意思。

不管你是t r a b还是直接分到一点区，其实最终都是在a点区，既然图上有，我给你解释一下t r a b的全称是什么呢，t r a b的全称叫做thread local t l。

这你应该知道thread local县城本地，thread local allocation分类八分缓冲区叫县城本地分配缓冲区，threload出来的buffer，我每次读的时候都想重新读一遍。

因为它特别具有那种韵味，这个单词，就跟那个耶路撒冷那词儿似的，就luclem是读起来就特别爽的感觉，thread elegation bus，但是这是伦敦伦敦口音啊，如果说你是呃美印是吧。

three relocal legation buffer，一般就会儿化音多一些，如果你是阿三的口音的，the logo allegation bb，说教英语对吧，来成都口音slg，你个瓜娃子。

所以logo你弄啥嘞，这哥们儿真够扯了对，一般都得扯一扯，开玩笑啊，开会儿玩笑，还是那句话，学习不要把自己搞得太累，搞太累了就没劲了，我要让你轻松地学，还能让你学好，这他妈才叫索菲亚，这才叫牛叉啊。

来看这里啊，虽然local alex buff，它是一个县城本地缓冲区，这什么意思啊，我们先说一般来讲呢肯定是要new一个对象，是要6~1点七的，6~1点区，但是你好好听我讲。

为什么还有这种叫县城本地分配缓冲区，这到底是什么东西，为什么会有这个呢，一分钟给你解释清楚，认真听这块儿哪块认真，我提前提醒你，你认真听就行了，同学们，你们想一下。

在一个程序启动好多线程都开始分配内存的时候，一定会发生线程的征用，征用的意思就是县城有可能共同抢这块空间，说我也要在这儿，你也要在这儿，那么这个时候jvm就要对这些县城做管理，做同步坑。

坑位就一个谁先进去坐下，谁就是谁的，不能所有人都进去，所以在这种情况下，对象的分配效率偏低，那这时候怎么办呢，所以为了提高效率，这么设计的这么一个机制，这个机制就是java语言启动的。

每一个线程都有自己私有的一块空间，一小块空间，这个空间呢也是放在一定区里面，私有的以后每个线程分配对象的时候，自己想new个对象怎么办，new到自己兜里听懂了吗，自己兜里站满了，再去抢公共空间。

就这么回事好了，这两个中间叫t r a b叫three local allocation buff，来get到这一点，同学老师扣个一，好我们继续一点，区里面的对象被清除的时候，这些清除一个dc来了。

妈妈来了，扫线团，线团被扫走了，那就结束了，这线头没被扫走，去哪了，还记得吗，survivor 1，survivor一里面再经过一次清除，年龄够了，老年代年龄不够，survival 2。

如此的循环往复好，回过头来再来看一遍，当我们有一个对象的时候，首先尝试站上站上分配下，就在站上，这里面有两个名词，第一个叫逃逸分析，第二个叫标量替换，刚才有同学老说，老师你再解释一下标量替换。

我再给你解释一遍，假如有这么一个对象，t一个类吧，它有两个成员变量，一个是int类型，一个是int类型，简单说这个对象完全可以用两个int类型直接替代标量替换标量。

简单认为基本数据类型能够用基本数据类型的组合来替代它，如果你学过c告诉我这个东西叫什么呀，这个东西叫结构体好看，这里总而言之，逃逸分析没有逃逸，标量替换可以替换，往站上跑，往站上放，战胜呃。

如果特别大个儿怎么办，老年代如果girl合适，然后呢站上有分配不下t l a b县城本地优先，县城本地满了，伊甸，伊甸区，伊甸区回收survivor，一survivor一再回收，年龄够了。

老年代年龄不够，survival 2循环往复，第二轮替换有什么用，说明你问这个问题，说明你不会因为站的作用，站只能放那个标量，放不了特别复杂的对象，好看，这里截个图是吧，像老师这么体贴的暖男。

还需要你截图吗，大哥，直接要整个文档，老师是不是口误了吧，对射中战，我主要是想看看你们是不是在认真听讲，开玩笑啊，来继续好，我想到现在为止呢，你应该明白什么叫做分带模型了，关于分区模型呢，嗯大多数人啊。

你们现在用的是这个线上的版本，因为很多人手头都有工作了，你们自己可以查一下你们整个线上的用到的jdk版本到底是什么，多数人应该是一点半少数1。7。6的，1。8高的很极少对吧，听我说在这个里面呢1。

8分带模型居多，但是1。8可以用g one，这是没问题的，我给大家讲这个由于时间关系，我给大家讲的时候呢，一定是讲最重点的，最常见的，好好听，我说在这里面呢分带模型里面有各种各样的垃圾回收器。

这个垃圾回收器呢由于它是分带模型，就是年轻代老年代，所以只要是分带模型，一定是成对出现，一定是这这这哥俩啊，妈妈就请这年轻代的是吧，爸爸请老年代的一定是成对出现好，那成对出现的呢包括哪些。

这都是一对儿一对儿的各种各样的组合排列，有同学可能就会说了，老师的排列组合太多了，这怎么记得住，不用记，因为常见的组合就这三种，123好，其中第三种叫1。8，默认，这个你应该掌握吧，1。

8默认的全称parallel，scange，parallel old，好简称，ps加po，你在网上查的时候，或者你们面试官问你的时候，跟你提到这些词一定要理解什么意思好，我再说一遍，1。

8可以用分带模型，也可以用不分带模型，如果是你是新建的，我优先推荐你们使用的是不分带模型，记住了，g one，这我们有时间我会给大家讲这方面的理论，但是大多数啊有那个没有这种经验的人呃。

自己的jvm都是往线上一扔，简单这哥俩的组合p p o，下面我重点给大家讲这六种，每一种到底什么意思，五分钟讲完五种，最后一种比较复杂，我们一点点讲好，我们可以继续了吗，可以继续给老师扣一，大家听我说。

第一种呢叫serial，这种已经很少用了，这种组合本身就已经非常少用了，只是存在于理论之中了，这种组合是最早的jdk的模型，jdk一点0。1的时候用的就是这种组合，这种组合叫serial serial。

年轻代，serial old cereal的老年代，所以他其实上下都都都都是serial serial，什么意思呢，来看这里，它叫做stop the world cing collection。

which uses a single dies thread，读十秒钟读一下，stop the world copy collector，which uses a single gic thread。

怎么有两个声音，你是不是开了两个窗口啊，大哥，而这里面有几个概念，第一个概念叫sw这个名词，请大家记住，凡是涉及到jc的这个名词必然存在，这叫做cw，叫stop the world，世界停止，啥意思呢。

非常简单，我刚才说了啊，你你女朋友，你男朋友在里面扔小线团玩，扔着扔着扔着垃圾回收器进来了，说你们仨都给我站墙角线，对你们来说，世界停止了，为啥工作，我们的我们的垃圾回收线程开始工作了。

这叫stop the world s t w，那如果他copy connector，就是用的算法是拷贝算法，which uses single re，简单的线程的呃，就一个一个single的dc特征。

一个单线程的通过图，很容易理解，你们哥仨在这里工作工作工作工作空间满了。