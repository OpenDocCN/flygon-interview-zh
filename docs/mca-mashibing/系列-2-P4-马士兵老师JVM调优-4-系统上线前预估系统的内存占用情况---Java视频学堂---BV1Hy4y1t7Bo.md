# 系列 2：P4：马士兵老师JVM调优：4.系统上线前预估系统的内存占用情况 - Java视频学堂 - BV1Hy4y1t7Bo

啥也不敢，两种作用，第一个调试用，第二个确认不用dc参与，就能干完活了，这时候你可以你就可以用app了，好到现在为止，我觉得脉络上的东西大家是不是掌握了啊，这个脉络上的东西，来掌握同学老师勾引我们。

下面往深入一点点细节脉络，有了对面试能有好多细节，但是你记住了，我这两天练营呢叫做实战训练营，你要想听实战，我就跟你聊，实战之中会产生内存溢出，教你怎么去定位，怎么去把它揪出来，怎么去把它给干掉。

如果你要想听理论，那就全是理论了，所以我们还是实战啊，听完实战，有些理论你不懂，但是你简历上就可以写，我有实战经验了，听完理论，我估计你也记不住，好看，这里给大家多记两笔。

现在问的比较多的cms开始或者说分带算法，只要只要产生并发的时候，并发的算法从cms开始，它的算法是什么，先给大家几个名词，感兴趣的你好好去网上看看啊，三色标记对不对，它会把对象分成三种颜色，黑色的。

灰色的，白色的，黑的已经全标记完了，灰的自己标记完成员变量没标记吧，孩子没标记吧，白的还没标记的，三色标记算法用来干什么的，用来进行并发的时候，做并发标记用的不容易产生问题的三色标记。

三色标记里面会有产生漏标，就是我刚才所说的那种最严重的问题，就是我标完了之后，这哥们呢把它标成垃圾，但它它它又变成不是垃圾了，好这种是最严重的三色标记，要想他这个算法本身是一定会产生这种问题的。

为了避免这种问题，cms的他的干法，这个，a，好cm s的干法呢，首先第一个呢叫三色标记，下面这段你一定听不懂啊，听我说你一定听不懂，我只是给你开拓一个你下一步可以去研究的东西，get到了吗。

你一定听不懂三色标记，三色标记会一定会产生错标，产生坐标之后，cms是怎么解决的，它的解决方案叫incremental，update叫增量更新，但是这个增量更新有问题。

因为在增量更新的过程之中也会产生错标大哥，所以呢，这也是为什么cm到最后一定要有一个remark的东西，好接下来，怎么把这个给挪这儿了，复制了一下啊，不小心，好，所以所以什么呢，所以第一。

所以g1 g一同样的也使用三色标记，但是它采用的算法是什么，它采用的算法叫做，ok g一的算法，g的算法叫什么呢，g一的算法叫做s a p b，哎呀牌不好，那什么了，排排好版了啊，很简单。

给大家写出来吧，好第一第一的算法叫什么，也是三色标记，加上s a t b它就解决了这个incremental update，最后必须要进行remark这个过程，所以它效率上有所提高。

这叫natural at the beginning，好，接下来z dc是什么，c d c是最难以理解的一种算法，这种算法呢叫，color red pointers，这种算法叫颜色指针，或者叫着色指针。

呃基本上不会有面试官跟你聊到这儿，因为市面上一点资料都没有，连国外的资料都没有，要想弄明白这个只有一个办法读hobo源码，哎很不幸的是老师读过，所以目前只有我能给你讲清楚，慢慢慢慢慢慢来吧好吧。

但是也别着急啊，因为这个东西没有人问啊，好吧，你随随便去网上找文章去，这颜色指针的也是特别复杂的一个东西，他是用c加加里面的指向java对象的那个64位的指针，其中的四位做出了一些相应的操作。

因为这里面还牵扯到操作系统的那种内存映射的问题，嗯现在呢问的面试官问的问题上呢，还目前还没有到这种水平，还到不了，所以呢你们你们先不用着急啊，另外呢如果说还要说的详细一点的话，其实这样的啊。

呃所有的分带算法，所有分带算法就除了他这种，就包括cms啊这种的，他们使用的用三色标记之外，还要加什么加写篇章，而这one呢是三次了解sb加写屏障，cdc是什么。

c d c是color pointer加读屏障，shen dog是什么，shen door color pointer，加写屏障，好，算法里面最复杂的部分就是这些了，大家呢给大家拓展一点知识面嗯。

你要是想学的时候呢，也可以去网上查一查好不好，ok了咱们大体讲完理论上这个东西了，下面我们来进行调优实战，但是大家听我说，直接实战吧，这些对面试没啥意义，你是在搞笑吗，实战才对，面试没啥意义。

这些才是对面试最有意义的，你可能弄反了啊，好看这里，我们现在来进行调优，但调优的时候呢，必须指定你要调哪种垃圾回收器，我可以帮给你调g one，我也可以给你调他六cm，我也可以给你给你调p加po。

所以咱们公开课上咱们的小伙伴们来讲，大多数人的水平其实多数都没有进行过任何的垃圾回收器的替换，所以多数人用的还是什么呢，ps加po，所以我们先把最简单的调清楚，也只有你把这个能认识清楚之后。

下一步你才能继续往下走，越往后会越容易，这个是最难的，p s加p o是最难的，听懂了吗，越往后是越容易的，你先来定义这个调优到底是什么概念，其实啊调休这个概念呢，很多人就就就就会理解的特别的不到位啊。

这个调优这个概念呢，其实呃大多数的这种面试的时候，总是问你什么om问题，那只是调优的概念之一，好吧，好看这里我们来聊这个调校的基础概念，听我说啊，这个调的基础概念调优呢。

其实啊那个就是大多数问面试的时候都问什么问题，都问这个o o m多数都问这个om什么意思呢，叫out of memory，内存溢出，就是玩着玩着呢，我这个单机玩游戏呢。

我觉得整个这vm呢我开始频繁的b c3 秒钟一次，三分钟一次啊，f d c频繁的f d c或者什么呢，或者直接就崩了，直接就崩溃，好崩溃，完了之后，你个东方快完了，你这时候该怎么办。

你去去里边怎么怎么怎么去找毛病，找问题啊，这种叫o o m，大家听懂意思了吧，那如果说从全面上来讲，到底什么时候调优呢，其实这个调优呢最好是你根据这番的规划先进行预调优，这也是调优的一部分。

优化这般旅行环境，比如说他有时候特别慢，你觉得受不了他卡顿，你觉得受不了好这个呢其实人家没有死，也没有频繁m b c，但是呢他就算不频繁，他也时不时的卡顿，时不时的就慢下来了。

时不时内存就慢慢的变占占占用更多了，有一块内存老师释放不掉，这叫优化环境，这是调优的一部分，还有一个就是解决这个b运行中的各种问题，比如说o o m，这是最常见的问题。

多数的面试多数人在网上说的条条指的就是这一块而已，当然我们今天实战就主要调这叫聊这块儿好吧，对说不定就是代码写的烂，我告诉你，我今天我我我给你讲完，今天那个就今明两天我给你讲完你的面试。

你的简历上会写出来，有过实战调优经验，但是面试官一定会问你怎么产生的问题，我告诉你，你要是不贴近实战的那种，面试官一眼就能看出来啊，写了个list的，有成员不断的往里往里装啊，也可以。

太土了太简单了好吧，我回头教你十种高级的老师给你准备了十种案例，知道吧，你随便挑啊，一定让你在面试官那过得去好看，这里我们一步步来，先针对ps加p，这三条的第一步。



![](img/a48d2b23e76e4323b456fc538defe4d1_1.png)

我们先了解jvm的长的那两行参数，等于说那个老师这版产品平行参数还有什么可了解的。

![](img/a48d2b23e76e4323b456fc538defe4d1_3.png)

好，先注意啊，我这里环境全是linux，咱们后面聊调优，你不要跟面试官聊，我是在windows下做调优，面试官直接大嘴巴子呼上去，你就可以撤了啊，mr demo，我是面试官，这十种会记下来啊，没关系。

我们vip还有十种，一共有20种，哈哈哈哈，windows咋了，what这个还要我讲，有多少jdk是跑在windows上的，你告诉我，好看这里啊，我们先来聊呢。

就是这个我先先认识调优的这种最最基本的一个操作，你得认识java命行参数该怎么玩，平时呢就是直接什么java p就直接开执行了，但其实java有好多明狼参数，变量参数呢本身有好几种，直接敲，你没看出来。

以横杠开头的一堆参数，看到了吗，哎conserver server模式执行gc p class path啊，刚那个什么version啊，这些个说version啊，杠x等等，呃。

这些呢就全是这种叫做java的标准参数啊。

![](img/a48d2b23e76e4323b456fc538defe4d1_5.png)

这些叫标准，这些哪个版本都有，哪个版本都能用，这叫标准参数。

![](img/a48d2b23e76e4323b456fc538defe4d1_7.png)

非常标准的好，还有一种参数把windows给干掉。

![](img/a48d2b23e76e4323b456fc538defe4d1_9.png)

104点，还有一种参数就是这个参数看到了吗，这个杠x杠s开头的叫print help on nonstandard options，跳一下java杠x回车，你会看到你杠x开头的又一堆好。

这个参数叫做非标参数。

![](img/a48d2b23e76e4323b456fc538defe4d1_11.png)

看这里特定版本hobt支持的特定命令版本变了，这里面的x开团的命令有可能会变，所以这叫非标。

![](img/a48d2b23e76e4323b456fc538defe4d1_13.png)

这个大概也有个几十个吧，像我在那个这个那个前面讲完的时候给大家讲过，这个就是mixed到底是优化的，还是说是那个那个纯纯纯解释的啊，当然还有纯编译的都可以，这两个参数这里面有几个参数呢。

我希望大家记一下，大概记一下，就可以了，就这个参数这两个参数，这两个参数我觉得呃作为调优，或者说作为那个设定，你这盘参数来讲，基本上是属于必用的，自己自己看一下x m s后面跟一个size。

xx跟一个size是什么意思呢，said initial java heap size啊，所以最初始的堆大小maximum知道吗，hip size最大堆哎，刚开始的队最最和最大堆。

当然还有m x m n之类的，就是设年轻代好看，这里。

![](img/a48d2b23e76e4323b456fc538defe4d1_15.png)

到现在为止我们接触的参数曾经后悔，你一看包括标准的，包括非标准的，加起来就几十个吧，哎可是很不幸的是，我们大多数的调优都是要以杠xx开头的参数，太不行了啊，那么杠x x开头的参数到底有多少呢，不好意思。



![](img/a48d2b23e76e4323b456fc538defe4d1_17.png)

你找不着他有多少，你不知道他有多少。

![](img/a48d2b23e76e4323b456fc538defe4d1_19.png)

他没有，他没写出来，有同学说有没有一个列表给我，不好意思没有，i'm sorry，没有有没有文档给我，没有，你说oracle得多恶心，简直能他妈气死人，就当初找找这些文档，找这些命令，没有没有文档方案。

没有全的没有，这两天数三考，这就这就算比较全的了，我给你自己去看就行了，但是也就讲了几十段而已，大家听我说有一个参数实际上是能够把所有的全打出来的，看这里这把，装x加上flag规则可能吃啊。

这个参数呢大家可以记一下，这个参数呢叫print flies with comments，什么意思，with comments，解释把那些个左右才能打印出来，并且带着解释给打印出来哇，有这个太爽了。

哎很不幸的是，只有第八组版本能用，所以同学们下一步你要干嘛，哎自己去编译一个jdk，好不好，编一个jdk编译成debug版本，你就可以玩了，好那位同学真的就不行了吗，别着急，还有还有办法。



![](img/a48d2b23e76e4323b456fc538defe4d1_21.png)

大家看这里，这个杠4s，这个print torflags，这个不行，还有个办法叫什么呢，叫print，flags，then print flags，这两天睡得太晚了，脑脑筋有点不够使了，对没错。

就是他啊，来print flags final，还有一个呢叫print flags initial，哎，这块意思是什么呢，就是把所有参数都给打印出来，它的初始值是什么，就默认值是个什么。

而flex final指的是什么，就是你最终设完了整个整个你的虚拟机起来之后，那些个参数值到底是什么，来我们看看它到底有多少，别没了，wc跟l呃，也不多，700多个而已是吧，不算太多。



![](img/a48d2b23e76e4323b456fc538defe4d1_23.png)

也就700多个唉，所以为什么这边调有比较值钱啊，大哥，哈这就别背了啊，教你最常用的，因为在这个文档里头呢，每一个常用的我都给你列出来了，看到了吗，就说两分钱值不值吧，太他娘的吃了，谁都觉得吃。

那我下一步教大家使用常用的这种面料参数啊，我们直接用一个比较复杂一点的案例吧，这个案例还是太简单了啊，因为细节特别多，我略过了很多，我们直奔主题而去好不好，如果时间够的话。

我可以给大家讲一些什么三色标记这一类的，比较有可能比较长，被考到的这些算法啊，这个明天看，明天时间好，大家看这里啊，呃在这里呢我们有一个代码，我们是我们测试用的代码文档分享吗，分享啊，放心吧。

当然分享了，老师分享的老师是特别喜欢分享的人，你没发现吗，各种都可以分享啊，没有没有问题好看，这里你知道分享一个知识是学这个知识的最好的方式，好看这里啊，我们来看这个小程序。

这个小程序呢是模拟了实际当中的一个案例，这个案例呢你完全就可以写在你的简历上，跟面试官这么说，但这个案例是相对复杂啊，可是我我就说越简单的案例，那那个面试官的肯定觉得越没劲。

所以你举案例一定要举得稍微复杂一些，这个案例你要好好消化一下的话，是可以做到的，好这个案例呢是什么呢，我们我们大致读一下这个代码，这个案例呢首先我说一下它的背景，这个背景是什么呢，是有一个程序。

这个程序呢叫做风险控制的程序，风险评估，风险评估什么概念，比如说我们银行里头存了一堆人的信息，好这个人的信息，我现在对他进行评估，如果我贷给他10万块钱，我回回回不来的风险到底是多大的小额贷款。

还有这种金融这方面的这种的风险评估模型特别多，那呃对它进行风险员工，当然这里面他个人的资料呢会非常非常多，我会把他的资料各种各样的都拿出来啊，你说他是什么时候花过支付宝，什么时候还过支付宝。

花了多少钱啊，今年挣了多少钱，工资是多少啊，什么乱七八糟，各种各样的信息全有，然后呢在里面把数据拿出来，通过我一个模型对它进行评估，看看我能够给他贷10万，还是我能给他贷100万。

还是我说我一分钱都不敢贷给他，因为他的信用太差了，好了大家理解这个背景了吧，来get到这个背景的同学，老师扣一下，面，我来解释这个程序是怎么写的啊，那我这种语怎么写的呢，这种语是这么写的呃。

比如说我就只考虑他的信用卡的信息，这个信用卡呢我就模拟了一下，它的名字叫cui infer，有同学可能在这里会抬杠，老师说老师你给我讲半天全都是模拟的案例，来大哥，我就问你。

我怎么样才能给你弄一个真实案例去，我告诉你真的弄不出来，别的我都可以给你弄一个真实案例，只有这个这种dc的模拟，我实在给你弄出真实案例来，为啥其实你想想，如果说人家一个电商在那里运行了好长时间。

然后才产生了一次这种o o m，我怎么去把那个电商给你搭起来，然后再模拟给你跑个一个月，两个月给你弄，弄出那个o m来，所以好多时候只能模拟，但是没有没有关系，你只要听到这个魂知道吗，就听话，要听音儿。

看东西，要看这个活儿，看这个根儿什么东西，你只要把这个理解了之后，回想你自己的做过的项目，你完全可以把它套上去，一点问题没有，不在这种金融公司这么吹，明显假呀，这不是吹。

你能不能把这里面的案例稍微换换呀，你就这么弱呀，大哥这学传统的教育都学死了，就得老师拎着你耳朵从头到尾给你灌进去，你才能够接受是吗，看这里啊，这sim卡信息cart info。

比如说这是他花花的某个钱吧，big decisional price，然后呢名字年龄啊，这个生日等等，总而言之里代表的是他个人的一些信息，当然这信息我再说一遍，实际当中会非常复杂，根据这个信息。

我会计算这哥们儿诶到底是能适合带多少钱，有没有风险，然后呢我们这是开了金粉，从哪里来的呢，肯定是从数据库里来，所以呢我做了这样一个叫get get all card info。

就拿到所有的cut info这样的一个信息，从数据库里头拿出来，放在一个list里面，ok我每次拿100条，我就拿了100条下来，把这个东西放到这个list里，返回回去，别抬杠啊，不想听也可以待着。

为什么要走呢，不想听热热场嘛，好看这里下面我对这个模型对它进行匹配，叫model fit，看看是不是能对它进行进行匹配，首先拿到这个list，我从数据库里拿出来一堆嘛，一堆模型拿到这个list。

接下来for h每一个做循环抑制的时候怎么干呢，我用一个lamba表达式，然后用一个线程池，schedule with fixed delay，过一段过一段时间之后。

每个人过一段时间之后才开始执行我这个方法m方法，m方法呢就是具体的来适适合呃，来匹配，来匹配我们整个这个这个这个程序的呃，他那个模型的这个过程啊，m方法，这个方法呢我没写任何内容。

因为这个匹配过程呢就没什么值得写的了，就可能匹配不匹配就行了，我们调这个方法就是每个都拿出来，按照一个固定的时间往后delay一下，然后就开始一个一个一个一个进行计算，接下来干了一件什么事呢。

我在我的主方法里面，主程序里面我起了一个线程池，threat to executor，呃，这个线程池里面的参数你要没学过的话，你肯定理解起来也费劲，我就暂时不跟你解释了，很简单，就是50个线程的线程池。

这是他的拒绝策略，就这意思啊，50个线程线程池开始运行，然后呢它就不停地从数据库里拿出那个一个list来，然后不停的进行model fit，每隔100ms拿100条出来干事。

每100个每每隔100个毫秒拿一拿，拿100 100条出来干事，就这么一个模型，这个程序呢看上去呢是没有什么问题的。



![](img/a48d2b23e76e4323b456fc538defe4d1_25.png)

但是运行起来问题就大了，好你们不要给我带节奏啊，什么老师讲的快一些，慢一些的快，对你来说，你基础比较好，你就稍微照顾照顾基础不好呢，对不对，慢了也没有关系，你这人听上去总是总是会有收获啊。

当然这个bug呢我先不跟你说bug到底在什么地方嗯，回头你拿这个文档之后呢，你可以去查一查好不好，我们来执行一下，执行一下这个小程序。



![](img/a48d2b23e76e4323b456fc538defe4d1_27.png)

![](img/a48d2b23e76e4323b456fc538defe4d1_28.png)

什么编译啊，乱七八糟的这种过程我都不给你演示，已经很给很给你省时间了啊，莫急好，大家看这里啊，为了让程序能够，运行的时间稍微长一点，能够多演示一些命令，所以我把这个内存的条件比较大，还是200兆。

但实际当中要比这大的多，如果你那么大的话，我估计运行两天才能看见问题，所以咱们必须得稍微调到200多小一点，刚x m s最小200兆，最大200兆，来同学们问问他这个问题，为什么最小和最大是一样的。

为什么，这个大家能能理解到吗，能get到吗，唉避免没必要的扩容和收缩，你只说说扩容了，你一个最小的是这么小，一个最大的事这么大，那么当你不断的在里边儿产生对象的时候。

这个m得不停的花资源来计算我下一步要扩多大呀，下一步扩多大呀，然后不用了之后呢，下一步缩到多少啊，下一步缩到多少啊，所以你如果确定这个程序就会用这么多内存，直接给他指定，这也是一个小小的优化方式吧。

好像xx叫print g c，print g c呢，这个参数比较简单，就是把gc的过程给我打印出来，然后执行这个小程序回收，或者再起一个终端，好每天来看这个小程序，现在已经有了gc的这个呃日志了啊。

gc education failure，多少兆多少兆啊，花了多少毫秒，没有关系，一会儿我来给大家解释g c的日志，今天没有的话，明天也给大家解释清楚啊，莫及，ok jc开始了，现在我们想象一下。

开始闭上眼睛，开始你的想象，这个程序是你写的程序，闭上眼睛想啊，所有人都close your eyes，来把你的现在在你脑子里开始浮现这样一个场景，你写了这么一个程序，把它放到了线上。

然后运行了很长很长时间了，好谁会发现这程序有问题，谁呢，谁会发现成语有问题呢，客户不我跟你说，客户只是会反馈比较慢，比较恶心哎，一定是运维同学们对报警系统对你们说的没有错，所以在你实际的工作环境之中。

比较好的公司会配专门的预警系统，运维监控系统，监控系统会发现一些问题，那么监控会发现什么问题呢，看这里我们来看它的问题出在哪，交大一个命令叫top，这个命令比较简单。

就是列出来目前整个系统之中对于系统资源消耗比较高的前面的程序，当然网管的系统一堆一堆的，不一定是这个命令产生，也有可能是报警产生的好，你仔细看，我们有一个1239的这样一个java的程序。

它是占了22%的cpu，11。4%的内存，有同学说不高啊，忘记，那我再提一个终端，克里一个简单的命令，我估计大家应该都见到过gps，这个大家知道什么意思吗，就是列出来我们系统里头的那些个java的进程。

有哪些个，我们会看到一个java进程叫做t15 f g c就是我们的小程序，它的进程号是1239，好看，这里就是他，所以对于网管来说，它会观察到时间长了，它会观察到这么一个现象，什么现象呢。

就是这哥们儿这个程序现在注意看啊，它是11。4的内存，再再执行一遍，还是美村的增长的有点慢啊，算你狠，还11。4，稍微等一小会儿哈，内存它就会不断的增长，因为这时候还没有占满我们200兆还是挺大的。

我跟你说这个小程序的bug特别恶心，这个小程序会引发什么样的情况呢，它会引发有可能啊，你看啊，现在已经变成13。7了，看到了吗，刚才是11。4，现在是13。7，营长了，啊sleep太久了对啊。

先不管那个是因为我内存设的一个比较大好这个小程序啊，他会把那个你平时看到的程序的可能会产生的那些严重的后果，都会有可能在这个程序在产生啊，他有可能会最后的结果是频繁fdc，知道吧。

也有可能最后的结果是oom，而且这两个结果是不是固定的，不一定会产生那种这个小程序还是比较恶心的啊，所以我是拿它来做典型好，你看到了这个内存呢在不断增长，并且呢它不会回收，如果一个内存它占的比较大。

但是它过一段时间之后就又少了，这个就没有关系，但是这个不是这个从11。4涨到13。7，它不会往回走，知道吧，那好了，现在，你的网管就开始来找你了，好你闭上眼睛，想一个美丽的网管走到你的面前，然后跟你说。

哥们，你写那个有bug，然后啪一大嘴巴子给你抽醒了，你弄的这个内存都快占满了，什么情况，看现在是15。3了，你让他容忍他走下去的话，很快就是90%多99了，我就我就我就不等到那时候了好吧。

那这时候你就说啊，大哥网管都是大哥，对不对，那网管都是老大，来大哥，你能不能给我开放个权限，让我上去看一眼，好网管，这时候说可以吗，如果是在一个特别牛的公司里头上了线的系统，绝对不让你不让你上去。

你放心吧，如果是这种情况，你就只能在你做做一个模拟环境，然后在那里不停的压测来模拟设计环境，看看会产生什么，这个我教大家啊，以后当然我们解释你能开始能够能够执行的到位，或者你交往管你来帮我执行好吧。

也可以，所以现在比较牛叉的运维都是会jvm调优的，你懂吗，真的一点不夸张，比较牛叉的运维，j vm调优，mysql调优，各方面的tom cat调优，他们都会好看，这里，我们下一步呢说要定位出这个程序了。

你已经知道这个程序有问题了，那下一步你你怎么去对待进行定位呢。

![](img/a48d2b23e76e4323b456fc538defe4d1_30.png)

我教大家几个比较常用的命令呃。

![](img/a48d2b23e76e4323b456fc538defe4d1_32.png)

g p s我教过大家了啊，也不说了，我们来看这个这stg stack呢其实跟我们现在这个程序的关系并不大，但是我教给大家好，this deck是什么东东，just de的意思是打印线城站2239。

把这个进程里面的线程暂停打印出来，全打印出来了，我就不一给你念了，这个这次带的命令也是非常有用的，目前解决我们这个问题它没有用，但是它本身是非常有用的，你要理解这个jdk呢他干了些什么事。

这大哥干了些什么事呢，如果我们挑一段读一下的话，你就会发现了，这次大概干了这么件事，他说有这么一个现状，现在名字叫pro 1 thread 33，然后呢他就是自己内部的标号40priority呃。

优先级操作系统的优先级，tai d n i d waiting on condition，正在等待某一个条件，waiting on condition，这个thread的状态是waiting，正在等待。

因为我们有好多好多的县城，因为县城市里有50个，还记得吧，他正在进行等待，下面是这个县城里头呢，诶调用了哪几个方法，pk方法，这个方法，那个方法等等，同学们，你们想想，看来我们动脑筋想一下啊。

我来找一个比较标志性的行程，我们来点clear，嗯这是一个rable的线程啊，这叫做attachener pthread，49啊，48等等，内线整好在最后面，这是我的main线程，看到了吗。

我们的主线程它的state是time waiting，正在等着sleting，正在sleep，就是刚才我sleep的时候，正好把他这个先锋站给他抓下来了，然后呢。

你看啊这个may may方法的调用了sleep方法，对不对，main调用了sleep，但是sleep如果再调别的，还会一层一层往上走，所以这个jdk干了一件什么事，大家我相信大家能get到了。

这次de是把每个线程揪出来，然后他会把这个每个县城里面哪个方法产生的这个县城，我这个县城正在执行哪个方法，这个方法又调用了哪个方法，又调用了哪个方法，这个现场的状态是什么，是在waiting还是在干嘛。

还是在running，还是在time的waiting，还有如果他能在waiting的话，它调用的是哪个方位上的，正在waiting object weight好，他正在wait哪个锁。

这是那个锁的具体的编号0x是没有是什么，所以这代表有什么用，来同学们告诉我，当你看完了他的输出之后，这back将来对你调什么样的问题会有用，能够猜得到吗，对检测思索对，没错啊。

所以如果你的程序有可能会产生死锁的时候，用什么来做jdk。

![](img/a48d2b23e76e4323b456fc538defe4d1_34.png)

对this deck，当然这个this deck呢对我们现在这个程序没什么用，我教大家而已啊，而且你这次带了产生之后呢，你要观察它正在哪个锁上产生的死锁，这个锁是一个哪个哪个类的对象。

你就很容易定位出来你哪个程序是产生思索了，我也给你写了个例子，自己去读好吧，好这里能再给大家扩展一个小小的知识点，大家读过阿里的规范吗，巴里的规范有一个华山版，最新的。

阿里的规范里头它有一个规定现成的名称，尤其是线程池里面的一些县城，要给他一个有意义的名称，都要写有意义的名称，当然这个你要是没学过老师的多线程高并发，你也不知道怎么写，有一个名称。

因为你得定义这个我们先不管，在阿里的规范里头，要求规定必须的，每一个县城都得给我写一个有意义的名字，你不能随便瞎叫，为什么能猜，能猜得到吗，原因是什么。



![](img/a48d2b23e76e4323b456fc538defe4d1_36.png)

方便定位问题，你比如说这个县城，他名字叫p1 thread一他他他现在到底干嘛呢，我靠我不知道啊，阿里产生的那种这代产生像他那种都是就是成百成百成百个县城，你从这县城里头要揪出来哪些个有问题的类似你好。

所以这文档到时候去哪领，上网搜吧，这文档去哪去哪找份文档还得让老师教你啊，哦看这里。

![](img/a48d2b23e76e4323b456fc538defe4d1_38.png)

有人就是这四个stack杠l，这杠l可以搜索特定的思索情况，并不是所有的情况他都会嗯嗯弄出来，所以你最终能该读还是要读啊，这个没有这个没有招好，就要带这个命令，我们再来看下一个命令。

这个命令叫这这infer。

![](img/a48d2b23e76e4323b456fc538defe4d1_40.png)

看这里这一份比较简单，这infer呢就是你那个目前这个县城啊，这个这个这个java进程就什么1239吧，好这个进程呢它的一些个虚拟机的一些信息，哎你比如说你的这个变成他的run，他们的名字啊。

他是谁提供的呃，它的各种的class lor，class path啊，包括它的一些启动的参数，就这些这些信息，这是用jifer可以来做的啊，你读一下，你看看它的这些参数到底是怎么做的是吧，年轻代表多少。

老年代表多少等等，读这些参数的，这里面其实有两个特别好玩的参数，我要有时间弄啊，可以给大家讲一讲，这里面参数是不是跟cm是跟那个那个那个什么有关系的，跟那个垃圾回收有关系的啊。

这个也是面试第六个比较恶心的问题，大家先记着吧，如果我忘了的话，找时间问我，我给你讲给你们听。

![](img/a48d2b23e76e4323b456fc538defe4d1_42.png)

就是这道面试题，这道面试题，为什么压缩指针超过32g会失效，这是一个特别恶心的。

![](img/a48d2b23e76e4323b456fc538defe4d1_44.png)

没问题啊，我看这里，呃这个参数其实这个命令呢也就是读一读而已，没什么太大用处，我们继续看。

![](img/a48d2b23e76e4323b456fc538defe4d1_46.png)

大家看这个j c杠c就观察动态，第三个情况，这个是特别有用的，如果你在没有更先进工具的时候。

![](img/a48d2b23e76e4323b456fc538defe4d1_48.png)

你用这个名字来干涉这dgg c j gg c1239 ，就是他会干嘛呢，他会给你说说这些情况，这些这些情况包括什么呢，包括你年轻代占多少，老年代占了多少，被占用了多少，去掉了多少。

survivor 0占多少，一占多少等等，这些信息，只不过这些名字显示起来的让人读起来特别的不爽，可读性特别差，当然jc杠t z呢，它还有一个，参数是可以指定每隔多少毫秒，你给我输出一次。

每隔多少毫秒输出一次，这样的话呢你就更有意义了，大家记得有人没东西就行了。

![](img/a48d2b23e76e4323b456fc538defe4d1_50.png)

还有同学说java东西太复杂了，我只想到现在你们觉得很复杂吗，真的觉得很复杂是吗，我告诉你，你去写那个就我家姑娘半天就能学会的，那个小孩们编程用的那个语言，那个不复杂，你知道吧，但是不值钱。

那个叫scratch，好看，这里还有一个命令叫j map好，关于这个命令，我们明天再讲好吧。

![](img/a48d2b23e76e4323b456fc538defe4d1_52.png)

ok有同学说了，老师你讲了这么多命令，感觉都不是很友好啊，不是很友好的原因确实是他初始的这个命令行用起来相当的不友好，当然有同学这时候就会说，老师有没有图形化的东西，有没有来，同学们告诉我。

如果有什么问你，你当时怎么调优的呀，你说你挂了一个图形界面，这个图形界面是什么呢，叫做j visual vm，有没有呢，当然有，有的是，一堆啊，我告诉你，我给你打开来看看，嗯这个。



![](img/a48d2b23e76e4323b456fc538defe4d1_54.png)

这东西呢我得给你抓住主线，千万别跑偏了，跑偏东西就多了，主要是主线没有那么难看，这里这dk一点八，java自带的工具，这vio v m，比如说，我们要是监测我们某一个java进程啊，我把它，本地的哦。

我的我的那些教育进程都没怎么起来啊，这个时候呢哎你就可以本地的进程，你就可以跟上去用这种图形化的来进行监视，看到了吗，哎堆战多少了，matter space占多少了，cpu占了多少啊。

哎装了多少个class啦，整个整个县城进城的这种活动的总数了等等，现成的抽样，还有呢抽样器，我现在有多少个，我现在有多少个实例啊，什么东西有多少个实例啦等等，全都显示在这里，爽不爽可以吗。



![](img/a48d2b23e76e4323b456fc538defe4d1_56.png)

我要教你们这个可以吗，好你要跟面试官聊，说我用的图形界面调优，面试官一个大嘴巴子呼上去好吧，你见过你们家服务器有的有有在你们家服务器上装图形界面的吗，有没有，没有了，哎我看有同学已经说了。

不是可以远程吗，没错这是你们家的linux服务器，然后呢，京东的你为了远程进行对它进行监控，开了很多很多的端口和协议，以便我们的j vu vm能连上来，我问你多少个控制安全的网管，允许你这么干，有没有。

把端口给你打开，所以你跟面试官这么聊，面试官要是稍微理解一点，就告就告诉你不专业，听懂了吗，这肯定不行，这是为什么我就教你命令行的原因哦，那有同学可能会说，老师我把它当不下来，你要说把它当不下来。

大嘴巴子准备好吧，直接就给你一大嘴巴子，当不下来，你知道一个当铺下来的文件有多大吗，大哥吃过吗，你知道在你dump的时候是需要执行一个j map命令，你的整个程序要暂停的，知道吗。

一个实际的这样的一个dmp文件，在那种性能稍微差一点的机上做分析，要花一天左右才能运行完，我告诉你，什么时候都可以dump，就只有一种情况，你们服务器崩了，只有这种情况下，你可以dump。

除了这种情况之外，你说我他正在运行呢，我给他当不出来，可以有这样的命令可以做到，但你不要跟面试官说，你是这么干的，难难太难了啊，告诉你，好看这里，那这人怎么办呢，当然就是使用命令行，有同学可能会说。



![](img/a48d2b23e76e4323b456fc538defe4d1_58.png)

那老师这么一大堆的这种图形界面没有用吗，我在讲vp的时候。

![](img/a48d2b23e76e4323b456fc538defe4d1_60.png)

也讲过这些图形界面，但是呢我告诉你这个这个不是说没有用，如果你说用过图形界面，用在什么地方，听我说在一种环境之下，就是上线之前的内测，比如说你游戏服务器放上去，在这里跑着，远程挂个界面。

甚至在这里开个图形界面都没有关系，你挂上他监控着他，这时候玩命给它做压测，看看它会会不会产生一些我们预料之中有可能会产生的一些问题，所以在压测上线之前的大量的压测好图形界面上没有问题，听懂了吧。

那get到同学给老师扣一，ok注意我接下来讲的东西很多都是真正实战之中的人们怎么用的啊，我告诉你，网上很多讲的呢是那个理想化的，听懂了吧，非常理想化的，看这里，这哥们儿已经开始复dc了，不停的复dc呃。

我们先不管它，下面我们来看呢，在实际当中我们用什么，实际当中呢我推荐使用一个工具，这个工具呢刚才有小伙伴已经打印出来了，他为了博取我的注意力，我已经看到了这个工具叫office好。



![](img/a48d2b23e76e4323b456fc538defe4d1_62.png)

关于这个工具，我觉得我不想在这里跟你专门的聊他怎么安装这一类的。

![](img/a48d2b23e76e4323b456fc538defe4d1_64.png)

好不好，没意义，office。

![](img/a48d2b23e76e4323b456fc538defe4d1_66.png)

这是阿里的开源，阿里开源的一个工具，哎我去还防不了。

![](img/a48d2b23e76e4323b456fc538defe4d1_68.png)

啊这个我就不给你们看主主主界面了，显得有点慢，你们自己去搜office，这工具一诞生之后，挺好用的，非常好用呃，也推荐大家使用那个阿里内部，他们也他们也用好吧，没有阿芬怎么办，运营不让装。

如果运维什么事都不让干，那你就只能用刚才我给你讲的特别土的命令来看，听懂了吗，那个都是java自带的，但是assets是可以装的，assets可以装，是为什么呢，你不用开任何的端口号。

你给我装一个程序就完了，哎，dos安装运行下载，我不想跟你讲了，可以吧，可以的，同学给老师扣一下载安装我不想讲了，ok，这个你还要老师讲的话，有点过分了，就看这里，我都是都10。20了。

我们把阿斯起个头，然后呢阿瑟斯的预习，大家伙呢也可以自己装上，明天呢我再来讲详细的过程好不好，同学们，我先给大家起个头，鸭子怎么怎么玩呢，我装好了之后呢，解压解压开之后呢，它是一个，这么说的叫什么b3。

14版本cda星连，然后呢，我们怎么去运行它呢，这么来运行最简单的运行方式，javon j执行一个占文件，哪个文件呢，就是office不点炸，office注脚下，这是一个纯命令行的东西。

好ok他找到了一个java process，我们把它attach上去挂上去，这个它的编号内部编号是一，所以我们敲个一，它挂上去了啊，try to attach，想attach上去不行。

我这程序是不是已经挂了，我怀疑，居然也踏不上去了啊，啊已经out of memory了啊，sorry，这个挂不上去了，你知道我重新把它起了，lear，先把这东西起来，我重新运行office，挂上去。

好当你看到这个界面的时候，说明已经启动，并且挂到了你的java进程上，你看到了office目前正工作在1459这个进程上，好，到现在为止，你可以用用office来干我刚才给你演示的那些命令行干的事儿了。

除了具备那些命令行的所有的功能之外，除了一个命令行工具，就是这个j map，这个g map us是没有覆盖的，除了他之外，其他的全都是aos里面全包含了，因此在alice alice里面。

大家用了一个工具就已经足够了，以后就在它里面玩，所以你说你以后写到简历上的时候，说我有个实战调优经验，拿什么调的懂，他听懂了吧，今天已经10。20了，咱就不继续了，明天我们继续好吧。

呃今天呢我留给大家一些大一的时间，如果大家有什么问题呢，你都可以问好吧，随便问啊，这v的所有问题随便王老师这招呼，老师长得像岳云鹏，我去，你能不能说我长得像，岳云鹏也太那什么了，点哈哈，开玩笑。

岳云鹏就越不，啊别着急，你们那我去好那个那个技术问题，技术问题慢慢聊啊，你别别刷，哎呦我的妈呀，别刷，现在老年代一比二一比三一比二，导致最近有出书，我们自己写的内部的那种呃。

给学生们用的教材多久一次正常，这个不一定看你内存多大，还有你的应用的情况，有的什么一次都算正常，有的可能一一小时一次都算不正常，看你内存多大吗，你你一个你一个你一个天文广场，要说你一小时就一次。

你自己想想它正常吗，不可能啊，一小时就被他灌满了，他能正常吗，怎么调优om了，那不叫调优，那叫调错了，做的过程，明天我讲给你听，我教给你怎么把它定位出来，安全点吧，杨怀大家别刷了。

杨怀都已经刷过好多遍了，是我们的v i p中p，因为他是杨玉环的弟弟，名叫杨环，开玩笑开玩笑啊，呃诶哪去了，vip中p安全点cp，换的什么概念呢，我先给你，我给你讲大体的概念，大体概念是什么概念呢。

就是说你看啊，这这是我们的正常的工作线程，我们的业务逻辑线程，我们的业务逻辑要让它停下来，我们来我们垃圾工作线程才可以启动，对不对，这是s t w，然后再停这个现场的时候，并不是说一刀切，二话不说。

夸机锁全从我cpu上给拿走了，直接把我gc gc线程挪进来开始运行，不是那么回事，为什么呢，因为有的线程你比方说正对这个对象上锁呢，上一半能让他停在这儿吗，不行，所谓的safe point指的是什么呢。

指的是我们这个县城得停到一个合适的位置啊，停下来的时候呢不会对前后的一致性产生影响，这个叫c point，好吧，写屏障也是上锁嘛，这个写屏障注意就是说。

因为m里所提到的读写屏障和我们平时所说的wallet，tel的那种内存上的那种内存屏障是完全两个概念，这个读凭证写篇章的意思就是说什么呢，说的是当发现这vm在执行某一种操作的时候。

我跟上去做一种背后的操作，这个解释起来比较抽象，我给你举个例子，你就知道了，你比如说看这里，我们说一个复制算法，a对象指向了b对象，然后b对象所在的区域要被回收了，它被回收的时候，它怎么被回收到。

它会把它复制到区域里去，不管是survivor是什么，把这个对象复制过去，那么同学们，你们想一下这个地儿的引用得跟着变，原来我这个地址值是指向这的，我最新的地址值得指向新的，get到同学有点扣一。

这个阶段听懂了吗，那指向新的是什么意思，注意这个过程对我们程序员的调用，正好要调用这个引用怎么办呀，你这个引用正正在变的，怎么办呀，这个时候就是在他挪动了之后，相当于在内存里面写了个新东西。

然后这时候产生一个屏障，屏障的意思就是在他挪动了之后，我马上跟进跟进做一件什么事儿，把这块儿给你更新了，这块儿同步性的给你做个更新，就是任何一次的垃圾回收，在挪动了对象之后，原来的引用里面的值进行更新。

但是这个更新过程对我们用户是透明的，你是看不着的，你还可以直接访问这个引用，这个东西叫post right barrier，叫他写后的一个评论，等他写厚了之后，顺带的做一些jvm不该做的一些操作。

这个叫屏障，这个叫post right barrier，叫完成完完事儿之后的写屏障，这点get了是吧，为什么阿瑟为什么屏蔽它，没有屏蔽他，只是没有实现这个功能啊，现在290废弃的原因cms毛病居多。

我刚才也说过了，他一旦碎片化完蛋了之后，我告诉你垃圾回收就卡死你了，用serial old的垃圾回收，你自己想想，你就想一个一个60多岁老太太，从头到尾他扫天安门广场服务器，啥事都不能干。

其他县城全都给我看着，都在天门城楼上给我看着，那什么时候都把老太太扫完了，程序继续，你们别刷没刷没刷，怎么判断，我说先别动g c，怎么判断什么时候s t w重新标记，你这句句整个句都不通。

重新来重新问文档的这些应该都有吧，这个文档是公开课的文档，能让你在简历上写上有一定的经验，能让你入个门呃，很多的细节这一篇文档也是装不下啊，我因为那个我给你讲一个g1 ，给你讲一个z d c的话。

没两个小时基本够呛，拿不下来，视频结束啊，配合docker部署方式调测试，可以用这个吗，可以啊，你也得占内存啊，你占内存它它它产生o o m它还是还会有问题吗，没有jdk，jdk依赖如何调用是几个意思。

什么叫jdk依赖，没听懂，压缩指针32g不是哦对，想跟大家讲这个问题了，首先首先首先你们知道什么叫压缩指针吗，先说这个大家知道吗，比较复杂，这个问题讲完，估计今儿就可以下课了，可以，嗯来看这里啊。

你挑一个命令，随便挑一个java杠x x x，in flags就是交易命令之后呢，你会发现它有两个参数，看这里是什么呢，网上很多文章把两个混在一起讲，我告诉你这两个不是一个事，仔细读一下他的意思。

这个单词啊就是压的意思，它是一个词根，com home是往里压，compress，comm是往里压的，意思是前缀，然后compress，比方说还有什么啊，impress这个是往内压一express。

对外表达，其实它本质上就是一个词根，好像好像好像讲远了啊，sorry，那个，有机会再讲英语，不讲哪来的，这个compressed叫往内压压缩压缩指针，画个图，当我们new一个对象的时候。

你有一个object new出来的时候，内存之中这个object分成四段，一段叫mark word，记录的是锁的信息和gc的信息，以及还是code叫mc word，这第一段占八个字节。

耳朵叫class pointer，这个class pointer是什么概念，class pointer的概念就是它会指向我我数的那个类，你比如说我new出来的是t，它会指向我的t一点，class好。

这个东西叫class，好这个是被压缩过的，正常的情况，一个64位的系统，你想想看那大腿想想也应该知道，指针长度一定是64位的，也就是八个字节，如果八个字节放在内存里的话。

你的整个对好名的呢多占了很多内存，因为你的内存呢也就那么小，四个字节装进去，它的寻址，四个字节的寻址已经四个g是多数情况下就够了好吧，所以呢这个时候呢他就给你压缩了，这个指针是多少呢，是四是四个字节。

下面这个呢是你的instant data，就是你的那个那个那个那个成员变量装置装的部分啊，你里面有个成员变量啊什么的都装，这这个叫padding，叫对齐，pdd对齐的意思是我们要对齐八字节。

就是如果你整个对象不能够被八图，往往前对你，比如说你到这，你这个对象是12个字节，不能没法整除，怎么办，一个四变成16个字节，能够被挖整除，这个叫做对齐，就是最后你这个对象大小一定是能够被八字节整除的。

这是一个最基本的点，也就是64位，因为你jvm的寄存器，机器的寄存器64位正好撞八个字节，所以特别合适，效率特别高，jvm读一个数据的时候，64位的八字节对齐，当然这里面有个参数。

你可以指定四字节还是16字节，随便你指定是默认八字节，get到这里的同学给老师扣一，好compressed class pointer指的就是把中间那个pointer那个指针给它压缩。

从八字节压到四字节，后面这个compressed opo全称叫ordinary object pointers，普通对象指针，object pointers，普通对象指针的意思就是说在你的成员变量里面。

如果有一个比方说spring name name等于一个字符串好，这个指针占多少，体压缩的情况占四不开，压缩占八，是压缩这个压缩指针有一个限制，这压缩指针在你内存超过32g之后自动失效，同学们。

如果你们有谁的激情，真的有32g的内存，32g以上的，你们自己都有实验什么时间吗，就是你啊你做这个实验，这个实验怎么做呢，我机器没有32g啊，所以我没法给你做，这时间这么来做。

你弄一个特别大个的list，一堆对象装到这个list里，他永远都活着，一堆对象装进去，然后你最后看一下这个list大概整体占了多少个内，占了多少的内存，然后你设你的内存值超过32，你就堆内存超过32g。

你看它占了多少，对内存不超过32g它占多少，我告诉你对内存不超32g，经过压缩，这里面占的内存数如果是555 百兆，那么它超过32g之后，这个可能变成750兆，还不做任何参数指定的情况下，为什么。

因为超了32g这个压缩指针自动失效了，它到底是怎么实现，它到底为什么是32g失效，唉呀，唉呀复杂，讲给你们听啊，最后一个题了，讲完完事啊，今儿就到这儿，就是说你你如果你的内存。

你比方说原来你你干一件事儿，你你们家内存32g啊，三三你们家内存20 24g，然后你觉得呢内存不够使了，你扩了一个16级，结果你会发现呢同样的东西你多赚不了多少，因为超了32g那个压缩指针失效了。

为什么会是这样的呢，嗯是这样的啊，你首先要理解一个指针，如果一个指针的长度压成32个字节，有32位就是四个字节，压缩之后它就四个字节，32位的指针来告诉我它能够寻找最大的是多少啊，二的32次方是四个g。

好这点大家能理解吧，四个g对，那么如果我用32位的指针，也就是说我最多能支持的内存就是四个g多了，我支持不了了，同学说，老师我靠，你照你这么说的话，你三你32级才不支持你，你这个32位指针。

你压缩了32位指针，你这32位指针是怎么支持到32g的，对啊怎么支持的呀，你们想想看，是一个二的32次方，四个g的四个g的地址，但是你发现没有任何的对象都是八字节对齐，八字节对齐啥概念。

你这个你这个你这个对他来说呢，比方说01234567，你放心，这个222的这个位置啊，一定不是个一定不是对象的开头，你能理解吗，因为它不能被八整除，刚才这句话你看看是不是该到了，就说我们比如有个地址。

就是零个字节到七个字节这么多，中间啊，我跟你说，这个字节绝对不是一个对象的，开头八字节对齐嘛，其实我这23 20分钟我可以用，我可以指责这个数吗，我可以，零八哎，我跳着来看看是不是就变成32g了。

细节上它是补零的啊，它是补了三个零，好了就到这里吧，好吧嗯，能盖到盖到盖到算了啊，这个jm知识面不是就支持的东西太多，一时半会真说不完啊，咱们今天晚上就到这吧，明天见，ok忘了就算了啊。

听懂听懂前面就行，明天咱们讲实战就就讲实战啊，一讲就讲懵了，很容易很容易懵啊，明天实战实战很简单好吧，明天再见，拜拜，今儿听不懂的，去预习一下那个office。



![](img/a48d2b23e76e4323b456fc538defe4d1_70.png)