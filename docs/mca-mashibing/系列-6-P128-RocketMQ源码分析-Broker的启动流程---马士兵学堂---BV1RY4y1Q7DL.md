# 系列 6：P128：RocketMQ源码分析：Broker的启动流程 - 马士兵学堂 - BV1RY4y1Q7DL

给他们再来回顾一下啊。其实作为一个broer，它的启动流程的话呢，相对来说还是比较简单的啊，怎么个简单法呢？就是它有一个类。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_1.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_2.png)

就是我们知道啊你如果说通过源码启动的话呢，它指定的这一个叫做 up这个类。后在这个类里面呢啊我们也知道它的启动是一个man方法。

man方法呢首先调用到我们的great controller这个方法里面来，然后在这个方法里面来的时候呢，前面都是一些参数判断，然后包括一些参数校验。然后呢创建一个我们的叫做bro confi。

就是我们常说的一些配置文件啊，然后它需要去创建啊叫做我们的la通讯的服务端和la通讯的客户端。也就是在我们这张图当中的这一个N和NRC。所以呢这里面它就分别创建出来了啊，然后创建出来之后的话呢。

大家要注意了，这个是它的一些创建的配置。然后创建完之后的话，底下就是解析一些我们的参数。嗯，这些东西呢就是没有太多可以说的啊。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_4.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_5.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_6.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_7.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_8.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_9.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_10.png)

学累了啊，等一下我们待会儿一起来答疑，好不好？那个那个欧同学。😊，啊，我们一起来答疑，我们先把这个源码来进行讲解啊。然后除此之外的话呢嗯它对一些主从架构还进行了一些单独的处理啊。

然后这些东西呢都不重要啊，这些东西都是一些判断参数啊，一些配置参数啊等等之类的啊。所以在流程里面呢我特意把它说成了就是去进行一些其他的参数配置，对不对？

然后的话呢它主要会进入我们的这个方法就是controll这个方法啊，这个方法里面呢要注意了这个方法里面的核心就是第一个它会去加载bro当中的主题信息，注意了这个主题信息保存哪保存在哪里了？

就是比方我在启动的时候，我设置了一个我的目录对不对？叫做D盘然后在第盘里面呢，一般来说数据是放到我们的stone这个文件里面来，然后在stone文件里面呢。

它有一个confi文件这个confi文件会保存什么呢？就是我们每一台。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_12.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_13.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_14.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_15.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_16.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_17.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_18.png)

work启动的时候，它会有保存相关的主题topic，还有保存相关的这个消费的offset，消费的偏移量，还有了一些什么其他的订阅的一些分组，对不对？还有了一些我们消费的一些过滤相关的信息。

所以你可以看到啊，这个地方我们打开这个topic的。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_20.png)

很明显啊，这些东西呢就是你启动一个bro的时候，它底下来会有一些jason相关的配置啊，就是你有多少个主题，对不对？然后每个主题里面有多少个队列，然后呢，它的权限是什么？然后还有一些其他的标识。

所以在源码启动的时候，大家可以看到啊，开始启开始了嘛，已经开始了啊，在这个地方就是分别把我们刚才的这些jason文件进行加载。比如说topic文件啊，O这是加载我们的topic文件，然后除此之外的话呢。

还有我们刚才confi里面的这些什么consumer，然后subscring group这种文件，就是这种订阅组的文件啊，所以这个东西跟我们的这个文件啊，它是一对应的。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_22.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_23.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_24.png)

好，这就是这部分的代码。所以在我前面的这张流程图里面呢，我们称之为加载bro的主题，消费进度、订阅信息、消息过滤类等等相关的信息。OK然后呢，在我们的这个核心方法里面。

就是这个bro controllertroll的核心的这个初始化的方法里面来，我们再看到它创建了一个存储组件。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_26.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_27.png)

就是作为roq啊，其实它的存储组件的就是存储的这个组件，最主要的类呢是defa message stone啊，是这样的一个类啊，这个类的话呢，大家可以看到，首先它把它new出来，new出来之后的话呢。

然后嗯大家注意了，一般来说存储组件刚开始是new对不对？然后底下是一些副本呢一些统计工具的配配置。然后到了核心的话呢，它有一个not方法。然后我们点进这个load方法的时候，要注意了啊。

一定它是叫做defa message stone这个类然后点进去之后，你会发现它其实就是把我们的这些文件进行初始化。因为大家如果使用过roq。

你会发现rock q里面呢它的主要的存储文件是这两个第一个叫做comity log这个文件，就是在这个com log目录下，然后呢，一个很长的0000零的文件。

然后还有一个消费索引的叫做consumq的文件啊，就是你底下对应个多少主题，对不对？比如说这。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_29.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_30.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_31.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_32.png)

还有了pition order，还有一些其他的主题。那么每一个主题它都是一个文件。然后每一个文件下面它会有一个目录，比如说01234，这个01234对应的其实就是队列，它底下呢就有4个队列。

然后在每一个队列里面呢，它有一个索引文件啊。所以的话呢在我们bro启动的时候，它就会把com log进行加载，还有了consomerq它也要进行加载啊，所以这两部分东西干的事情是一样的。

所以啊这个地方我们再点进这个load方法。😊，在这个load方法里面呢，大家发现了啊，它底下呢又是交给了一个叫做mifyq。这个mifyq是什么呢？😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_34.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_35.png)

大家可以看到啊，这个mifyQ的话。😊，在这个类里面对不对？在这个类里面呢要注意了，它里面用到了一个叫做存储的东西，主要用到了一个叫做写实复制的容器啊。

叫做copy a write every list。😊，就是它是一个我们存储文件的队列。但是在这个队列当中呢，它是本身数据基本上都是放到这个er list里面来。

然后er list里面其实是放的my file。😊，就是我们再把之前的这张图给他们回顾一下啊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_37.png)

就是作为rockQ，它存储的整个架构是这样的。就是这个send message是属于发消息，query message属于我们去消费消息或者进行查询消息。然后到了它的业务层这一块的话呢。

它的入口都是defa message stone所以这一层我们把它称之为业务层啊，这是我们常说的controll层。然后进入controll层之后呢，它有一个对所有文件进行处理的。比如说com log。

比如说conomer，比如说还有什么index fair，还有一些其他的东西，对不对？这称之为逻辑存储层啊，你也可以把它比喻成我们的serv层。😊，到了ss层之后的话呢，就是你要对所有的数据进行封装啊。

就是所有的数据进行写入，进行读取的话，最终它有一个存储IO。😊，啊，存储IO的话就到了我们的m。😊，OK这个在哪里下载？😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_39.png)

这个的话在直接你点击的这个官网里面就有下载，我是不是编辑一个公告了，看我这个公告。这个公告有有没有看到？就直播的这候有个公号公告啊，这个链接你去下。好不好？那，这里面我就不打断同学们了。

这个地方它有一个资料，这个里面资料的话，我把相关的东西都已经放进去了啊。所以的话呢，这个层次是非常清楚的。所以在我们去调用的时候呢，有时候你就看链路看不懂，对不对？

有时候我们的这个load方法明明是一个com log点load的方法，哎，为什么要去调啊。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_41.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_42.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_43.png)

里面有一个包装，对不对？然后在它点load，然后这个点load的话，你会发现这个m file它本身就包含了很多的这个m。所以呢这个地方它就会一个 for循环，把所有的文件拿出来。

然后把所有的文件拿出来之后，把它 new出来啊，扭出来到了我们的这个文件存储的IO类，就是专门去对文件进行读写，就是哪怕是读消息或者写消息，它都是通过这个m这个类来处理的。O好。

这就是我们刚才所说的这个文件存储中间的一个部分啊，然后文件存储的一部分呢，其实就属于我们启动的时候的这一个加载存储文件的这个功能。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_45.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_46.png)

啊，也就是说在我们的这个初始化的方法里面呢，它会要去加载我们reconq几乎绝大部分的这种消息的存储文件。OK多线程写会不会有问题？那个解释复制的话，它只是用来去管理文件。好吗。

那个显示复制它只是用来管理文件，只是用来去管理文件啊。最终它写入的话都是这个m来处理的。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_48.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_49.png)

这个m fairq这个东西呢，它只是负责去管理很多个文件。就是我们刚才打开这个目录，你会发现在作为roq里面呢，它stone底下有什么有comil log文件，有confi文件啊。

有这种conomerq文件，对不对？还有一些index文件，那总有个东西啊就行。😊，统一的管理。所以这是mifyq这个东东。好，那么再回来啊，最后的话呢，在这个初始化方法里面呢。

它要去开启一些比如说配置啊，还有一些持久化相关的电池任务。所以在我们源码跟踪里面，大家可以看到。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_51.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_52.png)

底下的这些东西就是一些我们常用的这种线程池。要注意了，在reck的源嘛里面啊，你会发现它大量的使用的线程池，包括这种定时任务的线程池。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_54.png)

你可以看到前面的这个东西呢，就是开启这个远程的，它开启一个服务嘛，就是把这个laty remote service这个东西呢给扭出来，对不对？然后这里面我也说了，在老的版本里面呢，它一般提供了两个端口。

一个是10911端口，一个是10909端口啊，但是的话呢在4。5。1之后默认情况下面，这一个端口呢基本上也没怎么用的。因为基本上一个端口也可以解决问题。

然后呢嗯这个东西就是我们刚才所说的这个端口的东东啊，端口呢，其实也不是说它写死了，就是我们可以看到原来它是1个10911嘛，它就是用10911减2就变成了一个10909啊。

这就是源码里面我们可以得知的一个就是什么VIP的一个china的一个端口号。然后底下的这些东西就是开启各种线程池了。比如说开启各种什么一大堆的什么破消息的线程池send message的。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_56.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_57.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_58.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_59.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_60.png)

message的，还有了什么que message，对不对？还有一些什么去负责一些心跳的啊，就是很多时候我们还要像 server发心跳，么bitat excuse啊，还有一些大堆的excutok啊。

然后处理完这些ex之后的话呢，大家发现它底下还用了一个方法叫做rejustest这个方法啊，这个redress叫做。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_62.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_63.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_64.png)

说搜索这个东西呢，大家可以看到它其实呢就是去负责什么，负责一些东西的注册。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_66.png)

我们知道作为嗯这个bro的话呢，它本身是作为一个na的remo叫做NRS称之为la remoteing就是类似于你一个网络通讯的服务端。那么在这个服务端的时候呢，嗯待会文件我把主流程讲完好不好？

我文件待会我会去细讲这个NRS呢，它其实是不是要去提供很多功能。因为你毕竟是个服务端。那你肯定要提供很多接口，一个2个、3个、4个、5个、6个、7个、8个、9个10个。

所以的话呢它用了一个这样的处理方式，就是说你是不是提供了很多的这种功能吗？那么每个功能我都是用这个ex来处理。那我怎么去确保这些东西可以动态的，比如说增加或者删除了，它使用了一种亮点技术啊。

就是大家可能嗯不知道大家有没有玩过，我们把它称之为叫做功能号的设计。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_68.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_69.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_70.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_71.png)

啊，大家有没有玩过这个功能号的设计，有玩过的话，可以刷个一。其实我十多年前就是李锦老师十多年前很早就做开发了。这个功能号的设计的话呢，其实在一些。😊，呃，传统的行业是做的非常的广泛的啊，没有好。

那我就来说一下这个功能号是怎么回事啊。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_73.png)

就是我们会定一个功能。因为我们要进行网络通讯的时候，其实发的消息都会差不多，对不对？然后我们都会通过一个端口来进行访问。比如说都是10911，或者都是一个端口，我们要去发消息，那怎么去区别这些消息呢？

那它的方式就是说在这个地方它的请求的头里面，这个叫request quarter，这个头里面呢，它会去定义一些类似于功能号的东西。比如说你这个里面它叫做send message10，那就是发消息。

如果呢你这个地方它有一个标识叫做query message等于12，那就是查消息。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_75.png)

然后底下呢还有一些其他的，比如说一些什么加锁啊，或者是还有一些获取路由啊，get remote inform by topic就是去获取这个主题相关的路由信息。那它可能定1个105啊。

这些东西我们把它称之为功能号。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_77.png)

啊，就是如果说你要去访问的话，你会发现在我的bro端，我就提供了很多功能号，功能号怎么办呢？通过这个reming service的regest这个东西去注册啊，就是一旦别人有个客户端。

比如说他要去发一个功能号叫send message。😊，那我的服务端是不是会收到这一条send message的指令？那服务端收到这个send message指令，谁来处理呢？😊。

那这个时候就在这个地方去注册功能号，所以呢他只要加上一个叫做reg啊一个这样的方法，把这个功能号注册。注册完之后的话，交给一个ex交给我一个我们常说的啊线程池啊，就是这样的一个线程值的任务来进行处理啊。

所以呢这就就称之为我们的bro就已经注册了很多这种消息发送的东西了，然后底下了还有一大堆的注册啊，其实你会发现这就是一些只要写好一个模板之后啊底下的东西了。

就是不断的去进行CD copypy copypy copypy copypy对不对？就是这种方式的话，以后拓展性会非非常强啊，你的bro增加了一个功能怎么办？在后面的代码里面加一个功能号。

然后再给一个我们的ex对不对？这不就行了吗？😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_79.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_80.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_81.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_82.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_83.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_84.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_85.png)

OK那好。😊，回到我们刚才的这个主流程啊，在这个主流程里面，你会发现啊，其实这些启动的这些定时任务啊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_87.png)

他主要就是为了去处理我们的服务端的一些请求啊，我们作为broer，他作为一个服务端，他要提供很多服务，就是你发消息，我要给你进行存储。还有呢一些我要去提供给客户端的，你像这种别人也有可能去消费消息叫普。

我要拿消息，那我也要提供服务。还有呢可能有一些其他的等等什么心跳啊，有一些其他的东东，他都通过这个功能号来进行处理。好，这个主流程走完之后的话。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_89.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_90.png)

在我们代码里面，我们接着再来看。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_92.png)

Yeah。再来看看呢底下的这些东西啊，就是也是起一些嗯我们的常说的这种叫做定时任务的线成池。这个定时任务的线成池呢就是去拿起一些状态啊，然后呢进行一些我们的这个消费的一些consum of的一些更新啊。

对不对？还有一些其他的过滤的一些管理等等之类的啊，所以这些东西呢，其实你去看的话呢，嗯如果到具体的点，可以看具体的任务啊，但是我觉得没有必要去完全去就是钻到里面一行行看啊，然后这个方法是不是就结束了。

就是我们的bro controlt里面的这一个最核心的这个init方法就结束了。然后这个方法结束之后，它是不是就回来。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_94.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_95.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_96.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_97.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_98.png)

回到我们的这一个brostar up这一个类里面的叫做grer broker control这个方法里面来，对不对？然后这个。这个里面要注意了啊，就是在这个地方初始化完之后再设置一个钩子方法。

就是钩子方法呢，就是GVM你如果说进行对应关闭的话呢，我会个钩子方法，把一些对应的资源进行释放啊，这也是常用的一种就是开源框架去写慢方法启动。同时的话呢你还可能要去触发一些啊就是GM关闭的时候啊。

如果说GVM通知我关闭了。那这个时候我会把相关的资源。比如说conttrol进行稍down啊进行一些释放。好，这就是我们刚才讲到的这一个方法啊。然后跑完这个方法之后的话呢。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_100.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_101.png)

你看到没有？在我的 main方法里面，它是一个双层方法的套嵌套啊，就是great broker controller。然后嵌套完之后呢，再一个star。所以跑完那个方法之后呢，进入这个star。

进入这个star方法，我们看这张流程图，它就是要去把前面这些加载new出来的一些东西全部要进行启动的，前面是不是我们new出了很多什么ex啊，注册了一些很多的ex任务啊。

那么在这个地方它就要启动所以这个star方法呢，顾名思义启动启动存储组件启动 native服务端，然后启动对外的一些通讯。

然后启动我们刚才的这些servservservservserv service啊，然后同时的话呢还要做个事情，就是像name server去发心跳包啊。

所以这个地方呢又使用了一个叫做s service啊这个心跳包。然后呢进行一个每默认情况下面是每隔30秒像name server发心跳包，然。😊。



![](img/e86fa0673e16bea7ebbf5dce2b783a20_103.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_104.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_105.png)

![](img/e86fa0673e16bea7ebbf5dce2b783a20_106.png)

整个的这个步骤就结束了啊，所以这就是我们刚才b克启动的一个整体。😊。

![](img/e86fa0673e16bea7ebbf5dce2b783a20_108.png)