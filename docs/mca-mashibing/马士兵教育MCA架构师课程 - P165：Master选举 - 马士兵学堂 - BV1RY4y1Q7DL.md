# 马士兵教育MCA架构师课程 - P165：Master选举 - 马士兵学堂 - BV1RY4y1Q7DL

好，我们接着来看下面一个问题，说一说关于ma选举的选举过程。那ma选举呢也是ES中呢面试频率比较高的一个问题啊。那么这是一道来自百世呃百度的问题。呃，对应的岗位薪资呢在35K到40K左右。

master选举呢，我们可以从以下几个角度来回答啊。首先呢是何时发生选举啊，也就是选举的出发条件。那么第二点呢是谁参与选举？那换句话说呢，就是参与选举的不同的几个节点角色分别有哪些，分别是什么意思？

那么最后呢就是我们的选举过程啊，那么选举过程呢相对来说比较复杂。那么待咱们待会儿呃详细来撸。

![](img/e951b9cfb121146b3e2a0f2b5c478202_1.png)

那么回答这个问题啊，咱们就从以下几个角度来回答就可以了。OK我们来先看第一个。那么什么时候触发选举呢？那选举的必要条件呢有两个啊，我们先来看。呃，下面一段话，那么这段话呢是ES中源码啊。

有有这么一段描述。那there are two fault detection processes running啊，这句话告诉我们呢，其实在ES的服务进程中呢，一直啊有两个错误检查进程啊，一直在跑。

那么这两个错误检查机制啊，那这两个错误检查的dection呢，它是用来检查我们当前节点是否存活的。那么其中第一个the first is by the masterster。

那就告诉我们第一个dection呢是由master节点来执行的。那么它的作用呢是通过pin的方式，你看pin all the other node在集群中呢发现其他节点是否存活。

那么这是第一个它的名字呢叫做n fault detection。啊，简称node FD。那么它的作用呢就是检查普通的节点啊，集群中的其他节点是否存活的。

那么另一个啊那其实就是检查master节点是否存活了。那么第二个呢，它是通过其他的普通节点像master节点呃，master节点发送聘请求来检查master节点是否还存活的。

那么它的名字呢叫master for detection呃，简称呢master fD记住啊，那么带master的不是由master来执行的，带ns的不是由ns来执行的，就是带啥的，那么是用来检查谁的。

带master的FD是用来检查master的ok记住这两个detection啊，一定要记住，那么。在此基础之上呢，那么我们来看一下触发选举的条件呢有两个啊必要条件。

第一个呢是当master FD节点发现master节点失联的时候，那其实就是普通节点。我们可以把它理解一个班级。那么班级里边有一个班长。那么当呃我们的普通同学啊。

普通的学员发现呃普通的学生发现master节点，就是我们的班长失联的时候，那么此时会触发选举，这是第一个条件。第二个条件呢是n FD。也就是说当我们的active masterster。

我们当前活跃的主节点啊，也就是班长。那么他如果发现集群中的活跃的候选节点不满足法定票数，此时它会主动放弃master节点的身份，也就是放弃班长的身份。好，那么这个法定票数具体是多少。

我们会在下一个问题嗯，讲这个脑列的问题，脑列的时候啊，给大家详细的去说。那么咱们在回答选举的时候呢，你只需要回答。那么当前如果master节点发现当前候选啊集群中的候选节点呢，他不满足法定票数的时候。

他会主动放弃master的身份，那么这个法定票数呢，就是我们当前候选节点小于法定票数。那么这个法定票数呢一般是2分之N加1。啊，比如说当前呢有5个候选节点，那么2分之N加1呢就是3啊。

最终结果呢就是2分之5加上一等于3啊，要取整O。好，那么这是法定票数的问题，这两个是出发条件啊。那么选举的时候有哪些角色会参与选举呢？其实选举的时候无非就是一个候选节点，一个。呃，选举节点啊。

咱们严格来说呢，其实一个叫投票节点，一个叫被投票节点。其实在ES中呢，咱们只要配置了master这个角色默认情况下呢，它就是一个选举节点啊，它同时又是一个投票节点。那么在ES中呢。

这种节点呢称之为masterible node，就是它是具备选举资格的节点。它同时又能给别人投票啊，这是第一个我们需要认清的一个角色，叫masterible。active master呢顾名思义啊。

就是指的当前集群中已经存活的它活跃的主节点。那一般情况下呢，一个集群中只有一个我们选举的就是它啊，我们所说的选举就是active master，它产生问题的时候。

我们要重新选举出一个active mastersterok从哪儿选呢？就是从master enable这些节点里边去选ok。第三个叫detected master neible，就是专用的主节点。

一般来说呢。小规模集群呢呃我们一般不配置detection，就是de呃这个专用的主节点啊。那么这种情况一般发生在规模比较大的集群中。好，那这个呢其实无所谓啊，这个如果要讲的多呢，那你其实没必要去去讲。

因为现在我们讲选举的话，你只要知道有master就可以了。voting only呢这个就比较重要了。么voting only呢一般指的是仅投票节点，就是阉割了他的被选举权。好，默认情况下呢。

ma它是可以给别人投票，也可以让别人给他投票的。但是如果我们在候选节点上配置了voting only，那他就只能给别人投票。好，这以上四个角色呢？适和我们选举啊，就是在选举发生的时候，相关的几个角色。

我们要知道谁参与选举。只有masterable啊，并且不能是voting only。那么只有具备了这两个前提条件，他才能参与选举。🤧好。😊，这是必要条件啊。在面试的时候呢，咱们也可以去提。

那下面呢我们来说一下选举的发生过程啊。好，我们来可以参考下面的这张图啊呃放大一些啊。

![](img/e951b9cfb121146b3e2a0f2b5c478202_3.png)

好，咱们从上至下来啊，那这个图呢比较详细啊，是通过源码逆向回来的。🎼好，那么pin and wait呢就是我们选举的入口。那么当前我刚才不是说有两个FD嘛，一个叫masterFD，一个叫nose FD。

那么不管是master FD还是noteFD，他们都会去执行一个叫pin and response啊。稍等啊。我们换一个颜色。

不管是master呢还是n FD都会去执行一个叫pin and wait的方法。那么通过这个方法呢，获取到的是响应当前节点pin请求的所有节点。所以但是它只是响应当前节点的节点。

而不包括执行pin and wait方法本身的这个节点。那么最终呢会将所有响应啊当前节点的节点呢添加到一个叫f pink response的列表里。那么这个里边收集到的就是当前活动的节点列表。

那么下一步呢就是local node啊，通过loc note方法呢获取当前执行pin and wait的这个节点，并且添加到f pin response这个方法里。

那么当前呢就是一个完整的呃呃活动节点的列表，咱们接着往下看啊，接着往下走。

![](img/e951b9cfb121146b3e2a0f2b5c478202_5.png)

🤧好，那么下一步呢是通过一个叫masterele啊，n and这个master。那么这么一个参数呢进行呃过滤，过滤掉的是无效的投标节点。那这个其实跟选举呢呃在选举过程中不是一个重要的环节啊。好。

咱们只需要知道有这么一个参数，它是过滤的。在面试的时候呢，如果你回答啊回答这个也行，不回答这个也行，那毕竟不是重点。那么最终呢对经过筛选的节点呢会放到一个叫pin。



![](img/e951b9cfb121146b3e2a0f2b5c478202_7.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_8.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_9.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_10.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_11.png)

response的这么一个节点里。呃，这么一个列表里，它是存储的生成的是活动节点呃活动节点列表啊。刚才那个前面加了一个for，现在这个是没有for，经过过滤的就没有那个前面那个FULL了啊。好。

刚才是有这个的。好，那么它其实就是说我们的这个选举的节点呢，就是从当前的这个列表里边进行的。只不过这个pin response里边有可能包含了已经存在的active master。

所以咱们下边呢就要分两种情况。好，如果我们当前这个节点啊，注意看。

![](img/e951b9cfb121146b3e2a0f2b5c478202_13.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_14.png)

如果当前啊我们在便利这个pin response的时候，因为这个pin response存放的是所有活动的节点。那么如果当前这个活动的节点是主节点，并且不是local node。那么在此种情况下啊。

其实我们是不需要选举的。因为它已经是主节点了，所以我们其实不需要选举。而且正常情况下呃，如果把呃把这个节点如果是的话啊，它会放到一个叫act master s这么一个列表里。那么正常情况下。

 team master s，它应该只有一个，因为一个集群中只允许有一个act master，如果发生了多个，那么就脑列了啊，那么就代表有问题了。所以说正常情况下就有一个，那么这里边允许存放多个呢。

是考虑到了脑列的情况。好，那么这种情况下是往呃下边这个分支呢是不需要选举的。因为我们集群中呢是有存活的主节点的。好，如果这个节表。



![](img/e951b9cfb121146b3e2a0f2b5c478202_16.png)

中啊，如果当前act master是一个空列表，那么代表当前集群中没有存活的主机点，那么意味着要发生选举，对吧？好，那么下边这个是不发生选举的一个分支。那么往右走呢是需要发生选举的一个分支。好。

这是第一种情况。那么第二种情况呢，就是当前活动节点是候选节点。好，那么此种情况呢。

![](img/e951b9cfb121146b3e2a0f2b5c478202_18.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_19.png)

好，要把它添加到一个叫master candidates啊这么一个列表里。好，最终呢要在选举之前呢呃我们要进行一次判断，判断当前这个列表节点的数量是否满足法定票数。



![](img/e951b9cfb121146b3e2a0f2b5c478202_21.png)

啊，通过一个方法叫has enough has enough candidates这么一个方法来判断当前的节点数量是否满足最小法定票数，跟刚才的逻辑是一样的。就是是否小于2分之N加一啊。

2分之N加一呢是我们人为配置的一个这个值啊，目的是为了避免脑列。咱们再回答面试问题的时候，咱们只需要回答是否满足法定票数就可以了。O好，那么如果满足了，那么选举的过程呢就是以下几个步骤。

首先呢是调用注意啊，这个方法呢确实就只叫elect master，前面没有S啊，它的方法名称叫elect master service，它的方法名称就叫做elect master。

通过调用这个方法来选这个选举过程其实就发生这在这个方法里边啊，那么选举的。

![](img/e951b9cfb121146b3e2a0f2b5c478202_23.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_24.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_25.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_26.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_27.png)

啊，基本逻辑呢就是我们要首先啊是选举排序后的第一个master candidates，就是masterable node。那么选举呢。



![](img/e951b9cfb121146b3e2a0f2b5c478202_29.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_30.png)

主要是两个啊主要是依托于下面两个条件。第一个，先按照集群的状态信息进行排序，最新的版本号排在最前面，然后再按照ID进行排序，ID最小的排在前面啊，那么集群状态越新的就排在最前面。

那么也就是说我们集群版本啊，有一个参数叫clastster states version越大，那么优先级越高，那么最终选举出来的这个优先级也就越高。

这是为了保证新的master拥有最新的集群状态即me data啊，避免commit的时候，me信息啊变更丢失。那么如果版本状态相同，那么我们就比比较它的ID就是节点ID节点ID越小排在最前面。

那么最终选举出来那个节点呢就是最新的临时master啊。OK那么以上呢就是这个选举过程啊，咱们其实只要把这几点给答出来就可以了。呃，答出来之后呢，选举出来是临时master啊。

选举出来临时master还要将版本呃，这个集群的状态信息分发到每一个节点啊。那么然后节点状态，就是其他的节点收到这个最新的状态信息之后呢，要加入到最新的集群里。



![](img/e951b9cfb121146b3e2a0f2b5c478202_32.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_33.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_34.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_35.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_36.png)

这么就是一个完整的过程。那么下面呢其实回不回答都可以啊。以上呢上面呢是主要选举过程。好，那么以上呢是我们关于master选举这个问题的答案。



![](img/e951b9cfb121146b3e2a0f2b5c478202_38.png)

![](img/e951b9cfb121146b3e2a0f2b5c478202_39.png)