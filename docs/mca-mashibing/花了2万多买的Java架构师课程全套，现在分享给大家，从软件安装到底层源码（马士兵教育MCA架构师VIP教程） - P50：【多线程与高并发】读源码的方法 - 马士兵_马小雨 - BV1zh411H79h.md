# 系列 3：P50：【多线程与高并发】读源码的方法 - 马士兵_马小雨 - BV1zh411H79h

多多讲一些内容，好这节课我们要讲的。

![](img/82727e3cf283a5bcf148670aa7900c78_1.png)

我继续往下讲的内容是什么呢，是要讲我带大家来了解这个retry lock啊。

![](img/82727e3cf283a5bcf148670aa7900c78_3.png)

到底它是怎么实现的，我们来看看它的源码层面是怎么实现的，同时我也教大家一下源码这个东西，你该怎么样去阅读好，大家已经了解过reaction lock了，其实比较简单了，就是reaction lock。

lock等于new一个reaction log，然后lock。lock，爱加加lock，点unlock搞定枷锁解锁，中间不给别人反应的机会，那现在的问题是，我想知道这个洛到底怎么实现的。

我想这个叫unlo到底怎么实现的，还有一个我想知道的是。

![](img/82727e3cf283a5bcf148670aa7900c78_5.png)

康down lash内部怎么实现，clic barrier内部怎么实现。

![](img/82727e3cf283a5bcf148670aa7900c78_7.png)

就是这些所有的这些新的所有里头，他到底内部都是怎么实现的呢，sama four内部又是怎么实现的，我勒个去太多了是吧，各种内部对，没办法啊，现在问问全部都问到源码级别。



![](img/82727e3cf283a5bcf148670aa7900c78_9.png)

那么怎么办呀，我们就去读嘛，读源码嘛，好，既然见识到读源码这个问题，原本这件事第一件，第一个事情呢是大家要承认一点，就是读原版很难很困难，好我们要承认一点的是，其实读别人的源码很困难。

困难的原因是什么呢，困难的原因其实是，你必须要理解别人的思路，大家知道你理解自己思路，或者理解跟你类似的人的思路，这件事是比较容易的，想想法都是一样的，我们俩都是住在农村，从小在小河边光屁股长大。

我们聊那个河边的那些柳树的问题，聊那些小虫子的问题，他一聊我就能理解，可是很不幸的是，那边是一白富美，天天住在天宫，每天都用各种的口红是吧，从来我们都没有用过的，所以他一聊这个色号的时候。

我就跟他聊不到一起去了，现在写程序的这些人就像住在天宫的人，而你就是那小小河边光屁股，那小孩儿你想理解他的思路，先让你的思维达到他那个高度，再说理解别人的思路，听我说读源码啊，不管你是读什么源码。

现在基本上，第一个要有一定的数据结构基础，你比如说那个priority q的问到的，别人11111句话就能说出来啊，这是一个最小堆啊，就堆排序嘛，堆排序里头就是小顶堆，一句话就搞定了。

可是你如果不了解这个数据结构，从来没有读过，你要去直接读那个priority源码，得你读半天，你也理解不了他到底什么意思，所以第一个呢要有一定的数据结构的基础，当然数学我刚才也看了。

我一直在给大家备这方面的课，如果你没这方面基础的话呢，也尝试着去读一下，简单的都没有都没关系，读源码，不要想着每一句话啊，他为什么在这里是爱家家是吧，哎为什么他不是那个就i加一是啊，为什么不是加减啊。

这这个取得例子稍微有问题啊，对不起，这为什么这个边界这里啊n的时候要减一，为什么要减一，为什么要加以边界，这里的处理你不要读这么细，没有意义，读源码最贵重的读懂思路就可以了，所以同学们，读源码的时候。

尝试去理解别人的思路，不要去追到那个特别特别细的，说每个地儿该怎么和什么要建，因为什么要减一，当然有一些结构性的东西，现在你看这个面试题的时候，你会发现他开始问啊，为什么要用这个因子来扩展。

为什么从八的时候变红黑数，从六又变又变回到列表，所以你要读的时候，还必须得大的这种层面上的东西，还得还得要进行思考，第二个呢要有设计模式的基础，大家要去读spring的源码。

do my best is源码，读nt源码，读这些个框架源码的时候，他可能没有这么多的数据结构，这种算法方面的东西，但是呢它有很多设计方面的东西，所以设计模式这块儿务必要理解你，比如说我今天带大家。

尝试带大家去读一下这个a q s，当然我所谓的尝试是要教大家怎么去读，a q s这种方法，它是用了什么什么模式呢，你们了解吗，template method模板方法。

call back function，回调函数，这两个数都一回事，所以如果说你了解设计模式，我一句话你就理解了，你如果不了解设计模式，我讲半天你也理解不了，所以同学们，我既然讲到这里了。

没有学过设计模式的同学翻回头去，坦克第一版，好吧，这里边我讲了所有的设计码是23种，怎么运用的，都加进去了，规矩不，你如果说时间关系啊行，高效率的学习，也没有必要从头到尾的这么全，看完我们今天说了。

q是什么temply method的吧，先去看这个设计模式是吧，当我们用到了别的，再去看别的好嗯，嗯能理解的同学啊，你给老师扣一好吧，就第一件事呢读读源码其实是比较困难，需要你有一定的基础的啊。

没有打好基础，同学要回去打基础，kb是观察者模板方法也可以呃，你学到最后的时候呢，就是说你可以做到那种呃心中无剑，手中有剑这个境界的时候，你就会发现呢这些东西都是互通的了，所以呢也不用去纠结了就好不好。

这这这个概念这东西是人类发明出来，帮助大家理解问题的，你如果要是死抠概念这件事就不对了，能理解就好啊，这次细一般认为quack是template method的，叫做模板方法，就是你手中心中无剑啊。

手工特别贱的时候，好你的你的你的经济就达到了，哈哈开个玩笑啊，好我们先来聊阅源码的阅读的原则，原版阅读原则是什么呢，以前有同学读源码这么来读，二话不说，我反正拿到那个源码之后，哇。

200多个文件全部一一字排开，打开开始读，得记着这个原则，就跑不起来，不读跑不起来的源码，一般你不要去看，他看也看不懂，很难看懂，叫事倍功半，跑不起来的原码，你不要去读，它读起来太费劲。

什么时候这个源码必须得能跑起来，跑起来有什么好处呢，跑起来的好处就是，你完全可以用debug 11条线的跟进去，举个例子，比方说这个look，我们如果说他没跑起来。



![](img/82727e3cf283a5bcf148670aa7900c78_11.png)

你只是静态的来读源码的话，怎么读呢，你就得这么来读。

![](img/82727e3cf283a5bcf148670aa7900c78_13.png)

and control lock好，你看到了啊，哦原来这个lock里调用了squire一好，那你就去读think到底是个什么东西，然后你发现think啊原来是一个自己的内部类。



![](img/82727e3cf283a5bcf148670aa7900c78_15.png)

好，这个sync在哪定义的呢，我在这儿定义的哦，它的父类是谁，absolute abstract cute synchroniza q s嗯。



![](img/82727e3cf283a5bcf148670aa7900c78_17.png)

你就读到了回去你继续读这个呃。

![](img/82727e3cf283a5bcf148670aa7900c78_19.png)

快一到底是什么概念，点进去你就会发现它跳到哪去了呢。

![](img/82727e3cf283a5bcf148670aa7900c78_21.png)

哦，amistra cute schronizer，这里面调用了trial choir，读起来非常的爽，点进去，你发现当你读到try acquire的时候，当你读到初二快二的时候，你读不下去了。

为什么呢，这哥们儿throw了一个exception出来，ok你还怎么读。

![](img/82727e3cf283a5bcf148670aa7900c78_23.png)

你没法读了是吧，但是如果这这个东西能跑起来就不一样，我刚才在讲的比较快，同学们能够能够理解吗，有没有什么有问题的地方，就是我刚才说的，就是如果说你他跑不起来的情况下，你读跑不起就行了，跑不起。

请问你读的话会读出什么问题来，就读着读着你读断了就断了，已经读不下去了，能理解的同学们，能理解的同学给老师扣一啊，ok那有同学说你你跑起来了，就不会读不下去吗，是的，当你能跑起来之后，我们在这里设断点。

点上去射好断点，这个断点射上去之后，我们用debug来跟踪，这得你们看不见我这菜单在这儿吧。

![](img/82727e3cf283a5bcf148670aa7900c78_25.png)

debug，debug跟踪的时候呢，好我们这个断点就设好了啊。

![](img/82727e3cf283a5bcf148670aa7900c78_27.png)

设好断点之后，我们跟进去跟到这个lock方法里边去。

![](img/82727e3cf283a5bcf148670aa7900c78_29.png)

first step into，跟进去之后你会发现哦。

![](img/82727e3cf283a5bcf148670aa7900c78_31.png)

原来它调用了acquire，没关系，我们再跟进去好，他调用了try也快了，没关系，我们再跟进去，当我们跟进到这个try acquire的时候，你会发现它不再去throw new。

那个什么exception吗，他在这里是已经有返回值了，return他是另外一个方法，为什么会这样，为什么会这样。



![](img/82727e3cf283a5bcf148670aa7900c78_33.png)

同学吗，为什么我没跑起来的时候，我读到穿了快乐的时候，我竟然读到了一个另外的一个方法，然后我跟起来的时候跟弄到了第二个方法，为什么，思考一下，在再回头看一眼啊，现在我读了trip的时候。

我现在跟踪到的是reaction lock。

![](img/82727e3cf283a5bcf148670aa7900c78_35.png)

里面的try快方法对吧。

![](img/82727e3cf283a5bcf148670aa7900c78_37.png)

但是如果我用静态的方法来读的话，look点进去，acquire，点进去，try require点进去得，我跟踪到的是abstracute，sychronizer的这一块方块，里边抛出的是异常。

我没法往下读了，没错是由于多态的存在，这里我们读到的是父类的一个实现，而真正运行的时候。

![](img/82727e3cf283a5bcf148670aa7900c78_39.png)

是跑的子类的一个具体的实现，try a quire analyze，analyze，这个和那个eclipse稍微有点不太一样诶。



![](img/82727e3cf283a5bcf148670aa7900c78_41.png)

有人the floor stries dependencies吗。

![](img/82727e3cf283a5bcf148670aa7900c78_43.png)

好pro这辆车。

![](img/82727e3cf283a5bcf148670aa7900c78_45.png)

![](img/82727e3cf283a5bcf148670aa7900c78_46.png)

啊不是，这是怎么找到他的。

![](img/82727e3cf283a5bcf148670aa7900c78_48.png)

那个他所有的子类的方法。

![](img/82727e3cf283a5bcf148670aa7900c78_50.png)

怎么找到它所有的子类的方法。

![](img/82727e3cf283a5bcf148670aa7900c78_52.png)

![](img/82727e3cf283a5bcf148670aa7900c78_53.png)

![](img/82727e3cf283a5bcf148670aa7900c78_54.png)

这里是吧，对你看到这个车二块呢，它实际上有一堆的这个子类的实现啊。

![](img/82727e3cf283a5bcf148670aa7900c78_56.png)

![](img/82727e3cf283a5bcf148670aa7900c78_57.png)

这个子类的实现里头呢它有好多，它到底运行的是哪个呢。

![](img/82727e3cf283a5bcf148670aa7900c78_59.png)

其实你根本，你要是通过这种静态的方法去读，累死你啊。

![](img/82727e3cf283a5bcf148670aa7900c78_61.png)

嗯ctrl t是吧，你点到类名上啊，不多说了，先不说这个，就说你得看他那些子类的视线，你看那些子类实现的时候，你不跑起来，你根本就不知道它运跑的是哪个，子类的视线。



![](img/82727e3cf283a5bcf148670aa7900c78_63.png)

所以这第一条原则我们就确定了，这是我给大家总结的第一条原则，就跑不起来，不读，好同学们能理解这个问题了吗，这第一条原则就跑不起来不读，能理解同学给老师扣一啊，一般的情况下跑不起来不读，但是特殊情况下呢。

读一下也没什么关系，尤其是读那个读那个新的，这种这种源码框架的时候，这个框架你要跑不起来，不要去读它没有意义，还有一种情况呢是你接受了一个，别人已经改过右手的代码，这事儿咱们同学不止一次的用到过。

我的学生不止一次的用这个遇到过，然后在这种情况下怎么办呢，跑不起来你就别去堵他了，如果代码跑不起来，你读起来没有任何意义，第一步先让他想想方设法让他跑起来再说，第二个问题在你实际问解决问题的时候。

就解决问题就好，你读源码呢，我们现在是为了面试啊，其实在原来很多时候是为了解决问题，什么意思呢，如果你接手了一个别人改过六手的代码，现在呢呃你的老板说，这个代码里面有些问题。

麻烦你往里头加一些功能或者修改一下bug，你解决问题就好了，你不要从头到尾再去读这个改六手代码，你读会读的累死你，目的性要强，我们解决问题就好，读的时候要一条线索到底不要用面来读，大家知道啊。

我们一个程序跑起来之后，可能这个程序非常大，一个main方法里边有没有各种put get呀，size呀，各种各样的其他的方法，每一种方法你读进去，这个方法很可能去调别的方法，这个方法很可能去调别的方法。

每个方法你读进去，你不要去怎么读呢，大面上所有的方法先读一遍，然后再去里边找什么，里边哪个没看懂等等，不要这么读，要一条线索到底一条线索到底什么，就读一个方法，这个方法你调了哪个方法。

这个方法你又掉了哪个方法，这么来读进去，无关细节略过，有一些那种边界性的，什么n n n到底是是边界呀，还是n减一啊，还是n加一呀，在你读第一遍的时候，没必要的时候先把它略过。

所以这四条原则大家看看能不能理解，第四条原则，第一个呢就跑不起来不读，第二个叫解决问题就好，第三个叫一条线索到底，第四个叫无关细节略过。

