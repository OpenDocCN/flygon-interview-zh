# 白嫖到马士兵教育价值23980的MCA架构师课程一次让你学够！ - P21：马士兵老师面试题：6.对象怎么分配？ - Java视频学堂 - BV1Hy4y1t7Bo

下一个下一个叫对象怎么分配，这个相对复杂一些，我们来看这个图，为啥要移动，刚才不是说过了吗，dc为啥要移动g c g c垃圾回收的过程是需要对象移动的，如果这块你没听不懂就放一边没事。

你听不懂的主要原因是因为你对gc不了解，你对jvm的回收过程不了解，总而言之，对象不是说分配完了之后，它就不动了，在这m内部它要拷贝来回拷贝，拷贝就需要动地址，动地址就需要改指针，放过吧。

基础不够的同学先把它先把它分问题先放过，先听能听懂的好吧，带着问题来，带着收获走，看这里我们来聊对象怎么分配，这个过程也是相对复杂，我给你讲大概的意思，听我说所谓这个对象怎么分配是什么意思。

就是当我们new出这个对象来的时候，它分配在哪个空间，jdk默认的垃圾回收器，jdk默认垃圾回收器呢叫做parallel scavenge，加上parallel old啊，不管总而言之。

jdk默认的你的内存会分成两部分，第一部分叫年轻代，刚尿出来的对象放在这儿，第二部分叫老年代，到了一定年龄之后的对象挪到老年代去，什么叫年龄，垃圾回收回收一次涨一岁，回收一次涨一岁。

回收了好多次都回收不掉，你你就是老顽固，扔到老年代去做专门处理，好对象的怎么分配的，过程是这样的，我们刚刚new了一个对象的时候，它会首先尝试在站上分配，嗯，我先讲完，我一会儿给你解释好吧。

我刚进来个对象的时候，是在栈上分配，呃有同学可能会说，sdx徐海涛你来了，我们刚刚就来个对象的时候，是在栈上分配，这个以前呢你你你你你你做java程序员的时候，你可能会做简单的指导。

就是刚刚扭出来一个对象，我们肯定是这个对象放到堆上吗，我今天把这个观念给你纠正过来，如果人家问你问到这个问题了，你就必须把细节说出来，刚开始new的时候是new在栈上分配，站上分配，如果能分配成功的话。

就直接分配在站上，然后站上有一个好处，就是站往外一弹，整个对象就自动的给消失了，什么意思，听我说，大家都知道我们的整个的内存的管理啊，无论是什么语言，都是听认真听，不论任何语言，基本都把内存分成两部分。

一部分叫占，一部分叫堆，这个站呢是整个运行空间里头操作系统直接帮我们管理的，我们自己的程序不需要管理，当一个函数开始运行，这里面就有一个战争的存在，就是这个函数里面的局部变量。

哎我在main方法里头是怎么写的呀，这样写的t小t等于6t好，这个main方法里头这个方法开始运行之后占一小块空间，这就是那个main方法的空间，这个空间里面存谁存自己的局部变量。

我们这个方法里面所需要分配出来的那些临时性的这样的变量，比如说小t就放在这好，小t等于6t那这时候new出来的t放哪呢，一般我们说说放到堆里面，对不对，但是啊记住他会首先尝试在自己的这个站上分配。

这叫战争，当然我一个方法要调用另一个方，另外一个方法的话，那就再来一个战争，如果再调用一个方法的话，就再来一个战争，这么多战争操作系统是怎么管的，很简单，一个方法执行完毕，这个战争自动弹出。

这块空间完全回收，所以弹出就不就把这站顶指针往下移动一下，特别特别简单好，讲到这儿了，这是这是计算机系的最基本的基础知识啊，呃这块如果你没有听太懂的，你给老师一个反馈，听明白的，给老师扣个一，来口水喝。

那么大家认真听，当你明白了站在最基本的概念之后，你应该就会了解到，如果我这个对象是分配到这里，直接在占领战争里面分配在站上有什么好处啊，方法一结束，整个对象不跟着就没了，我用得着专门的垃圾回收器吗。

用不着，为什么操作系统帮我管了o所以在栈上分配的好处就在于这儿，就是你呢就不用管了，就回收期的事儿了啊，直接就弹弹出去就没了，那位同学可能会说了，那我为什么还往堆上分配，往往占上分配多好，不好意思。

网站上分配是有条件的，什么条件呀，网站上分配的条件主要包括两个，这个叫做第一个呢叫逃逸分析啊，叫逃逸分析，第二个呢叫标量替换，细节细节这个细节太血淋淋，我就不展开，我就要跟你聊一下这个逃逸分析。

你就理解了，那个有同学可能会说什么叫逃逸分析，其实就是这个意思啊，你比如说我如果分配了一个对象，这个战争在自己的战争内部分配一个对象，这个对象如果只是我自己的局部变量用，没关系啊，只有我自己用得上。

而一for循环里面，不断的new对象，别人家也用不着，其他方法用不着，好这样的对象弹出去就弹出去，我是方法结束了，你放心的对象一定就没用了，所以就直接弹出去，但是如果这个对象被另外的一个方法里面。

我需要用得着的话，那你能随便弹吗，你要把这个弹出去了，下面这个t是不是就空指针了，他还有用呢，人家还没结束呢，这就叫逃逸分析，什么叫逃逸呢，就是说我在这里头a指向我的指针。

有没有逃出我的战争管控范围之内，你已经逃出去了，不好意思，我就不能再这样分开了，我就只能再堆上，堆上有什么好处，我这个tk指向他哎我这个t也可以指向他，来能听懂这块的老师扣个一。

ok这个时候就可以进行占上分配，战场分配的好处很简单，占一谈整个生命周期就结束了，所以管理起来特别方便，不过它呢是要进行逃逸分析，绝大多数的是不能再这样分配的，只有少数可以，ok这就是栈上分配的好处。

站上分配不了，这时候去分配在哪儿，听说这个时候看它个够不够大，个儿够不够大的意思是说，如果你的个儿特别大，直接扔到老年代，老年代的区域，刚才我说了啊，内存分成两大块，一块年轻带一块，老年代好。

老年代的空间一般来说比较大，好个特别大的，直接给我扔，老年代你就别跟我说年龄到了才扔过去，不要这是什么意思，有的有同学可能马上就会问说老师啊，那个到底有多大呀，这个东西是通过参数来控制的。

叫max chineering threshold，我就在这里不给大家展开这个细节了，这是jvm调优里头需要控制一个参数，叫max chineering，the result，叫最大的老年代阈值。

这个意思，那总而言之到一定个头直接扔到老年代，扔到老年代的话，如果这个对象想结束结束他自己的生命周期是需要经过垃圾回收的，一般我们需要经过fully c啊，全回收才可以，那如果说个不大不小啊。

站上呢又分配不了，有逃逸，分配不了怎么办，唉这个时候呢才会进入到我们的伊甸园区，当然在伊甸园区进入之前，还有一个特殊的优化的这样的一个过程，这个过程呢叫tb t r a b的全称。

thread local allocation buffer，来跟我读一下，叫thread local allocation buffer。

threlocal叫县城本地allocation分配buffer，缓冲区叫县城本地分配，有缓冲区，这是什么意思呢，这个意思就是说同学们你们琢磨一下，如果我们所有的对象都扔到伊甸园区。

好多县城都往伊甸园区扔对象，它一定会有现成的竞争存在，我也看上第10号地址了，你也看上第10号地址了，好我这个m就必须进行管理，谁抢到了算谁的，这个叫锁竞争就必须对线程进行同步，同步的效率是比较低的。

因此在这个阶段jvm又做了一个优化，这优化是怎么优化的呢，就是给任何一个线程，首先呢给你分配一小块空间，这把空间很小，但是这块空间归你这个县城单独占用就归你了，是你的private的，是你的线程本地的。

这是你们家那房子啊，你们家自己的窝，这是大家的客厅公用，这是你们家自己的卧室使用，来一个对象的时候，优先往自己卧室里放，往自己兜里揣，先不要占公共空间，自己的对象放在自己这里，他就一定只有一个现场。

他绝对不会产生说互相竞争的问题，所以这个效率就高了，因此这个我们叫t r a b的这样一个机制，这样一个机制的话呢，其实也是可以通过参数来进行控制，它可以关闭它，可以调整它的大小，这个都可以啊。

这个机制我就讲清楚了，那能跟上那老师扣个一就可以了，讲这可以了吧，对随着现成的文件而完全消失，那只是肯定的可以跟上good，好听我说接下来t r a b本身的空间也是在伊甸园区，所以呢它也是在伊甸园区。

不管怎么样呢，总而言之是分配到伊甸园区，在伊甸园区分配过来一段时间之后，经过垃圾回收，这个dc一般我们称之为y g c叫年轻代的回收，经过年轻代的回收，这个对象如果被回收掉就结束，如果回收不掉的话。

它会跑哪去呢，它会跑到一个幸存者区域，叫savior区，这里牵扯到gc是吧，稍微讲细致一点点好，这里是年轻代，这里是老年代，那么年轻代呢有伊甸园区，这是新对象的诞生地，人类的诞生地伊甸园。

然后呢还有两个小的区域叫survivor，一个叫survivor，一，一个叫survival，二，这个对象被回收的时候扔到这里，他活着就扔到这里，然后把整个区域干掉，下次再回收的时候。

这里的火车区域扔到这里，还可以把这个区域和这一类岩区全部都干掉，内部机制是这样的，所以经过垃圾回收之后的第一次，它会进入到垃圾回收的幸存者区域，survivor 1，如果没有被回收掉的话。

那如果回收再经过下一次回收，如果回收掉结束了，如果不回收掉呢，看他的年龄大小，如果您老人家年龄够了，不好意思，进入老年代，如果你老家的年龄不够，进入到另外一个server区域，如此的循环往复再说一遍。

整个内存大小算了，给你打个例吧。